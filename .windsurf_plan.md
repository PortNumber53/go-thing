# AI Agent Improvement Plan

## Objectives
- Add a chat interface for the AI agent to handle user inputs via chat and call tools.
- Implement a write_file tool restricted to a specific folder, with configuration in `~/.config/go-thing/config`.

## Steps
1. [x] Set up configuration file for restricted directory.
2. [x] Modify `toolserver.go` to implement secure write_file tool.
3. [x] Enhance `agent.go` for chat interface and tool integration.

## Updates
- Created config file at `~/.config/go-thing/config` with `write_dir` set to `/home/grimlock/work/go-thing/files`.
- Modified `toolserver.go` to implement a secure write_file tool that reads the config and restricts writes to the specified directory.
- Added terminal check to prevent hangs in non-interactive environments.
- Added debug logging for exit condition.
- Confirmed resolution of hanging issue with 'air' after adding terminal check and debug logging.

## Next Steps
1. Enhance `agent.go` chat interface for better tool integration.
2. Test the write_file functionality.

## PostgreSQL Integration (2025-08-09)
### Goal
- Add internal PostgreSQL support (not exposed as a tool) and run SQL migrations at startup.

### Plan
- Create `db/` package:
  - `postgres.go`: parse `[postgres]` in INI, build DSN, open `database/sql` using `pgx` stdlib driver, ping.
  - `migrate.go`: simple file-based migrations (`schema_migrations` table, lexicographic `.sql` files`).
- Wire into `main()` in `agent.go`: on startup, load INI, init DB, run migrations from `MIGRATIONS_DIR` (default `./migrations`). Continue running even if DB is not configured or connection fails.
- Provide `config.sample.ini` and an example migration under `migrations/`.

### Done
- Implemented `db/postgres.go` and `db/migrate.go`.
- Added `github.com/jackc/pgx/v5` to `go.mod` and `go mod tidy` passes; `go build` succeeds.
- Integrated DB init + `RunMigrations` in `agent.go` startup with logs.
- Added `migrations/0001_init.sql` example file.
- Added `config.sample.ini` with `[postgres]` example.
- Updated README with configuration and migration notes.
 - Added migration CLI in `agent.go`: `migrate up [--step N]`, `migrate down --step N`, `migrate status`.
 - Enhanced migration engine to support `.up.sql`/`.down.sql` conventions, stepwise up/down, and status reporting.
 - Added example down migration `migrations/0001_init.down.sql`.

### Conversation storage migrations (2025-08-09)
- Added `migrations/0002_conversations_threads_messages.up.sql` to create tables:
  - `threads` (id, title, created_at, updated_at)
  - `messages` (id, thread_id FK, role, content, metadata JSONB, created_at)
- Added `migrations/0002_conversations_threads_messages.down.sql` to drop `messages` then `threads`.
- Indexed `messages(thread_id)` and `messages(created_at)` for common queries.

## Debugging Agent Hanging Issue
The agent hangs when started with 'air' but works with 'go run'. Added detailed logs and flushed output to diagnose. Addressing lint errors (unreachable code, defers). Cause may be Air's signal handling or buffering.

## Task List
- [x] Research Air installation and configuration for Go projects
- [x] Add Air as a development dependency (via binary or config)
- [x] Create or update .air.toml configuration file as needed
- [x] Update documentation with instructions for using Air
- [x] Test hot reloading to confirm it works as expected
- [x] Debug agent hanging issue in agent.go (resolved)
- [x] Fix 'exit' command not stopping the agent (attempt)
- [x] Add logging for input handling and retest
- [x] Add detailed debugging for chat message handling
- [x] Fix Air-specific hanging and lint errors
- [x] Retest with Air

## Changes on 2025-07-27
- Added logging to geminiAPIHandler, chat handler, and main function to improve debugging of tool chaining and API interactions.
- Enhanced system prompt to strictly require JSON for tool calls or Markdown for final responses, ensuring better iterative tool execution.
- Changed configuration file format from JSON to INI format. Updated both agent.go and toolserver.go to use INI parsing with gopkg.in/ini.v1 package. Changed write_dir key to CHROOT_DIR in [default] section.

## Debugging Response Display Issue
- Investigated and added logging to chat handler to fix frontend display issues with Gemini responses.

## Current Goal
Add Jira tools for transitioning issues: list available transitions and perform a transition, wired into the agent tool system. Then test multi-step flows (get transitions -> transition issue).

## Changes on 2025-08-08
- Refactored tools to be modular with dynamic discovery/dispatch:
  - Introduced a registry-based dispatcher in `tools/toolserver.go` using `toolExecutors` and `tools` maps.
  - Moved `disk_space` implementation to `tools/disk_space.go` and registered via `init()`.
  - Moved `write_file` implementation to `tools/write_file.go` and registered via `init()`.
  - Simplified `toolserver.go` to keep shared types, HTTP handlers, and empty registries.

- Updated `agent.go` to discover and execute tools dynamically via the tool server, now embedded in-process:
  - `getAvailableTools()` now calls `GET http://127.0.0.1:8080/api/tools` and renders the dynamic list.
  - `executeTool()` now posts tool calls to `POST /api/tools` and returns the server response.
  - The Gemini system prompt's "Available Tools" section is built at runtime from the live registry (so new tools like `jira_search_issues` are immediately usable without agent changes).
  - Implemented `/tool` command parsing to delegate execution to the tool server and `/tools` to list the live set.

### Jira Transitions Tools (2025-08-08)
- Added `jira_get_transitions` tool to fetch available transitions for an issue, supporting query params: `expand`, `transitionId`, `skipRemoteOnlyCondition`, `includeUnavailableTransitions`, `sortByOpsBarAndStatus`.
- Added `jira_transition_issue` tool to perform a transition, supporting body keys: `transition`, `fields`, `update`, `properties`, `historyMetadata` and convenience `transitionId`.
  - Registered both tools in `tools/jira_issue_ops.go` with help text and parameters.

### Developer Experience Improvements
- The tool server has been converted into a reusable package (`tools`) and is now started inside `agent.go` (as a goroutine) on `:8080`. Running `air` in the project root starts BOTH the agent and the tool server automatically.
- No need to run a separate tool server process.

## Next Steps (Follow-up)
1. Encourage the agent to call `jira_get_transitions` before `jira_transition_issue` when transition id is unknown (prompt hint or chain-of-thought hinting via tool loop).
2. Add basic unit tests for the two executors.
3. Validate `GET /api/tools` lists the new tools and `POST /api/tools` dispatch works end-to-end.
4. Add an integration test for `agent.go` multi-step flow (list transitions then transition).
5. Document required config for all Jira tools (`JIRA_URL`, `JIRA_TOKEN`, optional `JIRA_EMAIL`).

## Frontend (React + Vite) and Cloudflare Workers Deployment (2025-08-08)
- Added a new React + Vite frontend under `web/` with minimal scaffolding (`index.html`, `src/main.tsx`, `src/App.tsx`, `tsconfig.json`, `vite.config.ts`).
- Added `wrangler.toml` at the repo root configured to deploy the built SPA via Workers Static Assets with SPA routing fallback:
  - `[assets] directory = "./web/dist"`
  - `not_found_handling = "single-page-application"`
  - `name = "go-thing-frontend"`, `compatibility_date = "2025-08-01"`.
- Updated `web/package.json` to include `@vitejs/plugin-react` for the Vite React plugin.

### Developer commands
- Install deps: `npm install` (in `web/`).
- Local dev: `npm run dev` (in `web/`).
- Build: `npm run build` (in `web/`).
- Preview build locally: `npm run preview` (in `web/`).
- Deploy to Workers (from repo root where `wrangler.toml` lives): `npx wrangler deploy`.

### Notes
- The Workers deployment uses Static Assets with SPA routing (`single-page-application`) so unknown navigation paths fall back to `index.html`.
- Backend/API integration can be added later via a Worker `main` script or by exposing your existing Go server behind an `/api` origin and proxying from the Worker.
- Vite dev server configured to allow the stage host by setting `server.allowedHosts = ['gothing.stage.portnumber53.com']` in `web/vite.config.ts` to fix blocked host errors when accessing via the staging domain.
- Vite dev server port changed from 5173 to 5174 via `server.port = 5174` in `web/vite.config.ts`.
 - Vite proxy targets updated from `127.0.0.1:7866` to `127.0.0.1:7866` for `/chat` and `/webhook` in `web/vite.config.ts`.

### Cleanup (2025-08-08)
- Removed the embedded HTML/JS chat UI from `agent.go` (`GET /`). The endpoint now returns a JSON health/info payload.
- The React/Vite SPA under `web/` is the only UI moving forward. During local dev, Vite proxies `/chat` and `/webhook` to `127.0.0.1:7866`.
- For production, build the SPA (`web/dist`) and deploy via Cloudflare Workers (configured in `wrangler.toml`).

## Jira User Tools (2025-08-09)
- Implemented multiple Jira user-management tools in `tools/jira_users.go`, registered via `init()` so the agent discovers them dynamically:
  - `jira_users_all` (GET /rest/api/3/users/search)
  - `jira_users_assignable_multi` (GET /rest/api/3/user/assignable/multiProjectSearch)
  - `jira_users_assignable` (GET /rest/api/3/user/assignable/search)
  - `jira_users_permission_search` (GET /rest/api/3/user/permission/search)
  - `jira_user_picker` (GET /rest/api/3/user/picker)
  - `jira_users_search` (GET /rest/api/3/user/search)
  - `jira_users_search_query` (GET /rest/api/3/user/search/query)
  - `jira_users_search_query_key` (GET /rest/api/3/user/search/query/key)
  - `jira_users_viewissue_search` (GET /rest/api/3/user/viewissue/search)

### Notes
- All tools read `JIRA_URL`, `JIRA_TOKEN`, and optional `JIRA_EMAIL` from the INI config (`[default]` section).
- Responses prefer simplified user fields when possible and fall back to raw JSON for resiliency.
- HTTP logs mask Authorization headers and truncate large bodies.

### Next Steps
1. Add unit tests for each executor with mocked HTTP.
2. Provide usage examples in the system prompt so Gemini can pick the correct user tool.
3. End-to-end test via `/tool` posts and through the chat tool loop.
4. Optionally add POST variants where Jira supports it (if needed for large queries).

## shell_exec Tool (2025-08-09)
- Added `tools/shell_exec.go` implementing a secure shell execution tool constrained to `CHROOT_DIR`.
- Behavior:
  - Executes `/bin/sh -lc "<command>"` with working directory defaulting to `CHROOT_DIR` or a validated subdirectory `--workdir`.
  - Enforces chroot boundary using `filepath.Abs`, `Clean`, and `Rel` checks (same pattern as `read_file`/`write_file`).
  - Supports `--timeout_sec` (default 60s, clamped to [1, 600]).
  - Returns `{ stdout, stderr, exit_code, workdir, command }` and treats non-zero exit as successful call with exit_code for caller inspection.

### Prompt/Agent
- No prompt changes required. The agent discovers the tool dynamically and lists it in the “Available Tools” section for Gemini.

### Next Steps
1. Add tests covering: workdir validation, timeout behavior, non-zero exit handling, and output capture.
2. Document usage in README with examples and CHROOT guidance.
3. Optionally add environment variable allowlist for commands if needed later.

## docker_start Tool (2025-08-09)
- Added `tools/docker_start.go` to start an Arch-based Docker container with the configured `CHROOT_DIR` mounted at `/app` inside the container.
- Behavior:
  - Runs `docker run -d --name <name> -v CHROOT_DIR:/app -w /app <image> sleep infinity`.
  - Defaults: `name=go-thing-arch`, `image=archlinux:latest`. Optional `--extra_args` pass-through for advanced flags.
  - Validates `CHROOT_DIR` from `~/.config/go-thing/config.ini` `[default]` section.
- Usage examples:
  - `/tool docker_start`
  - `/tool docker_start --name my-arch --extra_args "--privileged"`

### Next Steps
1. Add a complementary `docker_exec` helper to run a command inside the container (e.g., `docker exec -it <name> bash`).
2. Add a `docker_stop`/`docker_rm` tool for lifecycle management.
3. Document prerequisites (Docker installed, user in docker group) in README.

## Docker Sandbox + Lifecycle Integration (2025-08-09)
- Sandbox: `shell_exec` now runs inside an Arch Linux Docker container via `docker exec`, mapping `CHROOT_DIR` from the host to `/app` in the container and translating working directories accordingly. This isolates filesystem-touching commands from the host.
- Lifecycle helpers:
  - `StopDockerContainer()` and `RemoveDockerContainer(force bool)` added in `tools/docker_start.go`.
  - Added internal `dockerStop(name string)` helper.
- Agent shutdown: `agent.go` now best-effort stops the container on SIGINT/SIGTERM, and removes it when `[default] DOCKER_AUTO_REMOVE=true` in `~/.config/go-thing/config.ini`.
- Config sample: Added commented `DOCKER_AUTO_REMOVE` key to `config.ini.sample`.

Next:
1. Add tests for lifecycle helpers and `shell_exec` Docker execution path.
2. Document Docker prerequisites and usage in README (including `CHROOT_DIR` mapping and optional `DOCKER_EXTRA_ARGS`).
3. Consider explicit admin tool endpoints to stop/remove the container manually if needed.

## Interactive Shell Broker (2025-08-11)
### Goal
- Provide persistent interactive shells inside the Docker container that multiple clients can share concurrently (Agent logic, browsers, third-party apps), while maintaining shell state across commands.

### Implementation
- Added `tools/shell_broker.go` implementing a broker and `ShellSession`:
  - Single docker `bash` per session via `docker exec -it -w <workdir> <container> /bin/bash`.
  - Input multiplexing: session `inputQueue chan []byte` serializes all inputs.
  - Output broadcasting: subscribers per session receive real-time stdout/stderr.
  - Lifecycle: `CreateOrGet(id, subdir)`, `List()`, `Close(id)`; graceful shutdown on agent exit.
- Extended `agent.go` with REST + WebSocket endpoints:
  - `GET /shell/sessions` list active session IDs.
  - `POST /shell/sessions {id, subdir}` create or get a session; `subdir` maps under `CHROOT_DIR` to `/app/<subdir>`.
  - `DELETE /shell/sessions/:id` close a session.
  - `GET /shell/ws/:id` WebSocket to attach: send text/binary as input; receive binary output frames.
- Reused existing Docker lifecycle from `tools/docker_start.go` (`EnsureDockerContainer`) and chroot mapping to `/app`.

### Usage Examples
- Create a session targeting repo root and attach from a browser or app:
  1) `POST /shell/sessions {"id":"dev","subdir":""}`
  2) Connect WebSocket to `/shell/ws/dev`, then send commands like `ls -la` (newline auto-appended server-side).
- Multiple clients can connect to the same session and see shared state/output.
- Create separate sessions for long-running processes (e.g., server logs) while continuing interactive work in another.

### Notes
- Output frames are raw terminal bytes (TTY enabled); clients should render appropriately (xterm.js recommended).
- Inputs are newline-terminated if not already; for interactive UIs, send full lines.
- Env for the shell is cleared for safety; container provides environment.

### Enhancements (2025-08-11)
- Switched Docker exec bash sessions to use a real PTY via `github.com/creack/pty` in `tools/shell_broker.go`, fixing the "input device is not a TTY" issue and enabling proper interactive behavior.
- Improved sentinel-based parsing in `tools/shell_session_tool.go`:
  - Wrap commands with unique start/end sentinels using `printf` and normalize newlines.
  - Strip ANSI escape sequences from PTY output before parsing to avoid control code interference.
  - Anchor sentinel detection on line boundaries and handle split-chunk accumulation.
- Added post-command PWD sentinel so the tool returns the effective working directory:
  - Emits a `__PWD__<tag><cwd>` line between start and end sentinels using `printf '%s%s\n'` with `$(pwd)`.
  - Response data now includes `cwd` (effective after the command) in addition to `workdir` (initial session dir) and `output`.
  - Fallback logic retains partial output if the end sentinel isn't observed within timeout.

### Fix (2025-08-12)
- File: `tools/shell_session_tool.go`
- Change: Replaced `extractCwdAndTrim` logic to split output by lines, find the last PWD sentinel line, remove only that line, and rejoin the rest.
- Reason: Previous implementation could truncate output after the sentinel when it appeared mid-stream, causing data loss.
- Result: Preserves all legitimate output while still extracting `cwd`. Build verified with `go build ./...`.

### Minor Simplification (2025-08-12)
- File: `tools/shell_session_tool.go`
- Change: Removed redundant inner `if len(s) > tailKeep` in large-output tail handling since the outer `if acc.Len() > tailKeep` guarantees it.
- Reason: Simplify logic without changing behavior.
- Result: Cleaner code; build verified.

### Readability Simplification (2025-08-12)
- File: `tools/shell_session_tool.go`
- Change: Simplified final `cwd` resolution after `extractCwdAndTrim(...)` by directly assigning `cwdDetected = cwd` with a fallback to `sess.Workdir`.
- Reason: Improve clarity and reduce conditional verbosity without changing behavior.
- Result: Same behavior with clearer intent; build verified with `go build ./...`.

### End Sentinel Robustness (2025-08-12)
- File: `tools/shell_session_tool.go`
- Change: Removed fallback detection of `endMark` without a preceding newline. Now we only consider the newline-anchored pattern (`"\n"+endMark`).
- Reason: The wrapped command emits sentinels via `printf` with trailing `\n`, so the end sentinel will always be on its own line. The fallback could prematurely truncate output if the command's output happened to contain the sentinel string.
- Result: More robust capture avoiding accidental truncation; behavior aligns with sentinel emission guarantees. Build verified.

### Concurrency Fix (2025-08-12)
- File: `tools/shell_broker.go`
- Change: Added `writeMu sync.Mutex` to `ShellSession` and guarded `write()` to serialize writes to the PTY.
- Reason: Prevent potential race between the writer loop (input queue) and `Close()` sending `exit\n`.
- Result: Eliminates concurrent writes to the TTY; `go build ./...` passes.

### Security + Readability (2025-08-12)
- File: `tools/shell_broker.go`
- Changes:
  - Refactored `Subscribe()` and `Unsubscribe()` to use clear lock/defer-unlock patterns instead of dense one-liners.
  - Removed raw payload from PTY read logging to avoid secret leakage; now only logs byte count.
- Reason: Improve maintainability and prevent accidental exposure of sensitive output in logs.
- Result: Build verified with `go build ./...`.

### Subscriber Notification Fix (2025-08-12)
- File: `tools/shell_broker.go`
- Change: In `ShellSession.Close()`, close all subscriber channels under `subsMu` and clear the `subscribers` map.
- Reason: Prevent goroutine leaks in WebSocket handlers waiting on now-orphaned channels when a session terminates.
- Result: Subscribers are unblocked promptly; safe against races with `Unsubscribe`.

### WebSocket Writer Leak Fix (2025-08-12)
- File: `agent.go`
- Change: In shell WS writer goroutine, on `WriteMessage` error, log and explicitly `conn.Close()` before signaling done. Ensures the reader loop unblocks (ReadMessage returns) and the handler exits cleanly.
- Reason: Prevent goroutine leaks when the writer fails but the reader remains blocked.
- Result: Graceful termination of both goroutines on write errors; build verified.

### WebSocket Close-on-Session-Closed (2025-08-12)
- File: `agent.go`
- Change: When the shell session's `outCh` closes (e.g., session deleted or server shutdown), the writer goroutine now also calls `conn.Close()` after sending `[session closed]`.
- Reason: Proactively close the WebSocket to unblock the reader goroutine and avoid resource leaks while waiting for heartbeat timeouts or client disconnects.
- Result: Handler terminates cleanly on session closure; no lingering connections. Build verified.

### WebSocket Write Serialization (2025-08-12)
- File: `agent.go` (`GET /shell/ws/:id`)
- Change: Introduced a shared `sync.Mutex` (`writeMu`) and guarded all `conn.WriteMessage` calls in both the writer goroutine and the read loop (including session-closed notice and backpressure Close frame).
- Reason: gorilla/websocket forbids concurrent writes; previous code could race between the writer and read loop writes, causing panics/data corruption.
- Result: All WS writes are serialized; race eliminated. Build verified with `go build ./...`.

### Backpressure: Non-blocking Enqueue (2025-08-12)
- Files: `tools/shell_broker.go`, `agent.go`, `tools/shell_session_tool.go`
- Change: Made `ShellSession.Enqueue([]byte) bool` non-blocking; it returns `false` when the input queue is full. The WebSocket handler now detects a full queue, sends a `[backpressure]` notice to the client, and drops the input. The shell session tool returns a `ToolResponse` error so callers can retry.
- Reason: Prevent blocking the WebSocket read loop when a fast client overwhelms a slow shell, avoiding resource leaks and DoS risk.
- Result: Backpressure is handled gracefully without stalling; `go build ./...` passes.

### WebSocket Heartbeat + Close-on-Backpressure (2025-08-12)
- File: `agent.go`
- Change: Added read deadlines and a `SetPongHandler` to implement a 60s heartbeat for `/shell/ws/:id`. On input-queue saturation, the server sends a Close frame (PolicyViolation) and exits the loop.
- Reason: Detect dead clients to prevent goroutine leaks and fail fast under sustained backpressure instead of stalling.
- Result: Healthier WS connections; handlers terminate promptly on dead peers or overload. Build passes.

### Next Steps
1. Authentication/authorization for `/shell/*` endpoints; session ACLs/read-only mode.
2. Optional session TTL/idle timeout and explicit `stop/remove` container admin endpoints.
3. Client focus/lock semantics to avoid interleaved typing conflicts.
4. Structured event protocol (JSON frames) optionally wrapping raw stream for metadata.
5. Persist minimal session metadata in DB if needed.

## Current Context Memory (2025-08-10)
### Goal
- Let the model maintain a concise rolling context in JSON under `current_context` (and accept legacy `current_content`), and have the agent persist and resend it on future turns.

### Changes
- Updated `agent.go`:
  - `callGeminiAPI(...)` now receives `persistedContext []string` and injects a "Persisted Context (current_context)" section into the system prompt. Path: `agent.go` function `callGeminiAPI()`.
  - System prompt updated to instruct the model to optionally include `current_context` in tool-call JSON, with guidance to pick/prune only high-signal facts (<= 8 items). Path: `agent.go` in `callGeminiAPI()` system prompt assembly.
  - Extended `ToolCall` struct to parse `current_context` and `current_content` arrays. Added helper `GetMergedContext()` and `mergeStringSets()` to dedupe and merge. Path: `agent.go`.
  - `geminiAPIHandler(...)` now maintains a rolling `currentContext []string`, merges new context from each tool-call JSON, and passes it back into `callGeminiAPI(...)` on subsequent iterations. Path: `agent.go`.

### Behavior
- Model may return tool-call JSON like:
  ```json
  {"tool":"write_file","args":{"path":"/app/repo/README.md","content":"..."},"current_context":["the working dir is /app/repo/","you're using Arch, btw, as root","you can install whatever you need","the last packages installed was npm and nodejs"]}
  ```
- Agent extracts `current_context` (and `current_content` if present), merges/dedupes, keeps up to the last 8 facts, and includes them in subsequent prompts.
- Final Markdown responses are unchanged; only tool-call JSON may include the optional `current_context` key.

### Notes
- Build verified: `go build ./...` succeeds.
- Also removed a duplicate/partial `geminiAPIHandler` definition and a stray line in `processUserMessage()` to fix syntax lints.

## Performance Optimization (2025-08-10)
- Precompiled the double-slash collapsing regex at the package level in `agent.go` as `doubleSlashRegex` and refactored `normalizePathInText()` to reuse it, avoiding recompilation on every call.
- Affected code:
  - Function: `normalizePathInText()` in `agent.go`
  - Variable: `doubleSlashRegex = regexp.MustCompile(([^:])//+)` defined at package scope
  - Benefit: Minor reduction in CPU and allocations when normalizing many strings (hot path for context and messages).
- Also pre-allocated the result slice in `mergeStringSets()` in `agent.go` using `make([]string, 0, len(base)+len(extra))` to reduce allocations during context merging.

## Slack Error Handling Fix (2025-08-10)
- Fixed regression in `handleSlackMessage()` where errors from `geminiAPIHandler(...)` were logged but processing continued.
- New behavior: on error, log, send a friendly Slack message ("Sorry, I encountered an error. Please try again."), respond to HTTP with `{status: "error_processed"}`, and `return` early to avoid persisting/sending invalid replies.
- Affected code: `agent.go` function `handleSlackMessage()`.

## Error Propagation Fix (2025-08-10)
- In `geminiAPIHandler(...)`, errors returned by `callGeminiAPI(...)` were logged but suppressed by returning `nil` as the error value.
- Update: now returns the original `err` to the caller and an empty message string: `return "", currentContext, err`.
- Impact: callers (e.g., HTTP handlers, Slack handler) can correctly detect failures and handle them instead of proceeding as if successful.

## Request Context Propagation (2025-08-10)
- Updated `agent.go` `handleSlackMessage()` to pass `c.Request.Context()` into `geminiAPIHandler(...)` instead of `context.Background()`.
- Benefit: respects client disconnect/cancellation and avoids orphaned work; aligns with best practices for request-scoped cancellation in Gin.

## Config Read Optimization (2025-08-10)
- Cached `CURRENT_CONTEXT_MAX_ITEMS` using `sync.Once` and a package-level variable in `agent.go`'s `getContextMaxItems()`.
- Rationale: avoid repeated config file access and string parsing inside the `geminiAPIHandler` loop (hot path).
- Note: value is fixed for process lifetime (consistent with config load via `sync.Once`).

## Minor Refactor (2025-08-10)
- Simplified `ToolCall.GetMergedContext()` to directly return `mergeStringSets(tc.CurrentContext, tc.CurrentContent)`.
- Rationale: reduce verbosity; `mergeStringSets` already handles empty/nil slices.

## Security Improvement (2025-08-10)
- In HTTP `/chat` handler, replaced detailed error echo (`fmt.Sprintf("... %v", err)`) with a generic message to avoid leaking internal details.
- Logs still record the full error for debugging; clients receive: "Failed to process message. Please try again later."

## Path Normalization + Config Cache (2025-08-10)
- Cached `CHROOT_DIR` using `sync.Once` (`chrootDirOnce`, `chrootDirCached`) to avoid repeated lookups in the hot path `normalizePathInText()`.
- Fixed a regression by restoring `normalizePathInText(s string) string` return signature and proper returns of `s`/`s2`.

## DB Index Optimization (2025-08-10)
- Added composite index for query optimizing latest assistant message lookups:
  - Up: `migrations/0004_messages_thread_role_id_idx.up.sql`
    - `CREATE INDEX IF NOT EXISTS idx_messages_thread_role_id_desc ON messages (thread_id, role, id DESC);`
  - Down: `migrations/0004_messages_thread_role_id_idx.down.sql`
    - `DROP INDEX IF EXISTS idx_messages_thread_role_id_desc;`
- Rationale: speeds up `getLastContextForThread()` in `agent.go` which filters by `thread_id` and `role` and orders by `id DESC LIMIT 1`.

## Small Refactor (2025-08-10)
- Extracted path normalization helpers from `agent.go` into `path_normalize.go`:
  - Moved: `doubleSlashRegex`, `normalizePathInText()`, `sanitizeContextFacts()`.
  - Kept `getChrootDir()` in `agent.go` (shared cache), used by `path_normalize.go`.
- Cleaned up imports in `agent.go` (retained `regexp` as it is used by `/tool` parsing).
- Benefit: smaller `agent.go`, clearer separation of concerns.

## Context Utils Refactor (2025-08-10)
- Moved context-related helpers from `agent.go` to a new `utility_context.go` for maintainability:
  - `getLastContextForThread(threadID int64) ([]string, error)`
  - `getContextMaxItems() int` (with `sync.Once` cache vars)
  - `mergeStringSets(base, extra []string) []string`
- Cleaned imports and removed duplicate cache vars from `agent.go`.
- Verified with `go build ./...`.

## Gemini Refactor (2025-08-10)
- Extracted Gemini-specific logic from `agent.go` to `gemini.go`:
  - `callGeminiAPI(...)`
  - `geminiAPIHandler(...)`
  - `ToolCall` struct and `GetMergedContext()` method
- Cleaned up imports and removed duplicates from `agent.go`.
- Build verified: `go build ./...`.

## Robustness Fixes (2025-08-11)
- Updated `utility/tools.go` `ExecuteTool()` to improve reliability and error propagation:
  - Handle `json.Marshal` error for the request payload and return a wrapped error.
  - Use `bytes.NewReader` for HTTP request body instead of converting to string.
  - Replace deprecated `ioutil.ReadAll` with `io.ReadAll` and handle its error.
  - Return a clear error on non-2xx HTTP responses (include status and body snippet).
- Imports updated to use `bytes` and `io`; removed deprecated `ioutil` import.
- Verified with `go build ./...`.

### Follow-up (2025-08-10)
- Moved Slack helpers/handlers under `utility/` to reduce top-level clutter and decouple from `main` internals:
  - `utility/slack.go`: `SendSlackResponse()`
  - `utility/slack_handlers.go`: `HandleSlackMessage(...)` with injected deps (`getOrCreateAnyThread`, `geminiAPIHandler`).
- Updated `agent.go` webhook route to call `utility.HandleSlackMessage(...)`.
- Replaced top-level `slack.go` with a minimal stub comment (no code).
- Build verified: `go build ./...`.

## Misc & DB Utilities Refactor (2025-08-10)
- Extracted generic helpers to `utility_misc.go`:
  - `summarizeToolResponse()`
  - `maskToken()`
- Extracted DB helpers to `utility_db.go`:
  - `createNewThread(title string) (int64, error)`
  - `storeMessage(threadID int64, role, content string, metadata map[string]interface{}) error`
- Removed moved functions from `agent.go` and cleaned imports.
- Build verified: `go build ./...`.

## Config & Logging Utilities Refactor (2025-08-10)
- Extracted configuration helpers to `utility_config.go`:
  - `loadConfig()`
  - `getChrootDir()`
  - Moved related cached variables (`configOnce`, `configData`, `configErr`, `chrootDirOnce`, `chrootDirCached`) and `dockerAutoRemove` handling.
- Extracted logging setup to `internal/logging/logging.go`:
  - `logging.Setup()` writes to stdout and `debug.log`, routes Gin logs as well.
  - Removed old `setupLogging()` from `utility_logging.go` (now a stub pointing to internal).
- Removed moved functions/vars from `agent.go` and cleaned imports.
- Build verified: `go build ./...`.

### Follow-up (2025-08-10)
- Removed obsolete `utility_logging.go` after migrating to `internal/logging/logging.go` to avoid duplication.
- Build verified: `go build ./...`.

### Follow-up (2025-08-10)
- Moved misc helpers to `utility/misc.go` as package `utility` with exported functions:
  - `SummarizeToolResponse(success bool, data interface{}, errMsg string) string`
  - `MaskToken(s string) string`
- Updated `gemini.go` to import `go-thing/utility` and use `utility.SummarizeToolResponse`.
- Moved DB helpers to `utility/db.go` as package `utility` with exported functions:
  - `CreateNewThread(title string) (int64, error)`
  - `StoreMessage(threadID int64, role, content string, metadata map[string]interface{}) error`
- Updated call sites in `agent.go` and `slack.go` to use `utility` package.
- Removed `utility_misc.go` and `utility_db.go` to avoid duplication.
- Build verified: `go build ./...`.

## Slack Utilities Refactor (2025-08-10)
- Moved Slack-specific logic from `agent.go` to new `slack.go`:
  - `SlackCache` struct and its `Get`/`Put` methods
  - Per-channel lock registry: `getSlackChannelLock`, `removeSlackChannelLock`
  - `ensureSlackThread(channel string)`
  - `handleSlackMessage(...)`
  - `sendSlackResponse(channel, message string)`
- Removed the above from `agent.go` to reduce file size and improve maintainability.
- Build verified: `go build ./...`.

## Refactor (2025-08-10)
- Moved path normalization helpers into `utility/path_normalize.go` as exported `NormalizePathInText` and `SanitizeContextFacts`.
- Updated `gemini.go` to call `utility.SanitizeContextFacts(...)`.
- Replaced `path_normalize.go` at repo root with a stub comment to avoid duplicate symbols.
- Build verified: `go build ./...`.

### Follow-up (2025-08-10)
- Removed the legacy `path_normalize.go` file from the repo root after verifying all references point to `utility/` and build passes.

## Gemini Refactor (2025-08-10)
- Moved Gemini logic to `utility/gemini.go` with exported `GeminiAPIHandler(...)`.
- Moved context limit helper to `utility/context_limits.go`.
- Updated `agent.go` to call `utility.GeminiAPIHandler` and pass it into Slack handler.
- Removed old root files: `gemini.go`, `context_limits.go`.
- Build verified: `go build ./...`.

## Security Hardening (2025-08-11)
- Locked down WebSocket upgrader origin checks to mitigate CSWSH:
  - Replaced permissive `CheckOrigin: func(...) bool { return true }` with `isAllowedWSOrigin` in `agent.go`.
  - `isAllowedWSOrigin` allows origins from `[default] ALLOWED_ORIGINS` (comma-separated) or falls back to same-origin (`http(s)://<host>`).
  - Added `ALLOWED_ORIGINS` to `config.sample.ini` with examples.
- Build verified: `go build ./...`.

## Performance Optimization (2025-08-12)
- Cached WebSocket origin allowlist in `agent.go` to avoid per-request parsing:
  - Added package-level cache: `allowedOrigins map[string]struct{}` and `allowedOriginsOnce sync.Once`.
  - Updated `isAllowedWSOrigin()` to populate the cache on first call and use it thereafter; falls back to same-origin if no allowlist is set.
  - Benefit: reduces allocations and CPU on the WebSocket upgrade hot path.
  - Build verified: `go build ./...`.

## Observability Improvement (2025-08-12)
- File: `agent.go`
- Change: Added an explicit error log in `isAllowedWSOrigin()` when `utility.LoadConfig()` fails while reading `ALLOWED_ORIGINS`, noting fallback to same-origin policy.
- Reason: Avoid silent fallback that could confuse operators when CORS appears broken due to config load issues.
- Result: Clear log line `[ShellWS] failed to load config for allowed origins: <err>. Falling back to same-origin policy.`

## Proxy-Aware WS Origin Note (2025-08-12)
- File: `agent.go`
- Change: Added an inline comment above the same-origin fallback in `isAllowedWSOrigin()` explaining that `r.TLS` may be nil behind TLS-terminating proxies, suggesting honoring `X-Forwarded-Proto` or configuring Gin trusted proxies.
- Reason: Prevent misdiagnosis when clients connect via HTTPS through a reverse proxy but the backend computes `http://` for same-origin.
- Next: Optionally enhance scheme detection to read `X-Forwarded-Proto` when present and configure `SetTrustedProxies`.

## Shell Session PWD Extraction – Perf Improvement (2025-08-12)
- File: `tools/shell_session_tool.go`
- Change: Implemented the more memory-efficient slice-append approach in `extractCwdAndTrim()` and removed the unused `outLines` variable.
  `strings.Join(append(lines[:foundIdx], lines[foundIdx+1:]...), "\n")`
- Reason: Reduce allocations and simplify code for large outputs while keeping readability.
- Status: Implemented; build verified.

## WebSocket Single-Writer Guidance (2025-08-12)
- File: `agent.go`
- Change: Added comments at both WS write sites (writer goroutine and reader loop) warning that gorilla/websocket requires serialized writes and suggesting a shared `sync.Mutex` to guard all `conn.WriteMessage` calls.
- Reason: Prevent data corruption/panics due to concurrent writes.
- Next: Implement `writeMu` to guard all writes.
