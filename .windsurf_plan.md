# AI Agent Improvement Plan
### Jira Webhook Conversation Threading (2025-09-07)
- Behavior change: switch to thread-per-issue for Jira webhook events.
  - The handler in `routes/jira_routes.go` now derives a title `Jira: <ISSUE-KEY>` and calls `utility.GetOrCreateThreadByTitle(...)`.
  - Previously, we created a new thread on every event; earlier behavior reused the most recent thread. Thread-per-issue balances context reuse without cross-issue mixing.
  - Messages stored under the same issue key accumulate in the same thread.


## Objectives
- Add a chat interface for the AI agent to handle user inputs via chat and call tools.
- Implement a write_file tool restricted to a specific folder, with configuration in `~/.config/go-thing/config`.

## Steps
1. [x] Set up configuration file for restricted directory.
2. [x] Modify `toolserver.go` to implement secure write_file tool.
3. [x] Enhance `agent.go` for chat interface and tool integration.

## Updates
- Created config file at `~/.config/go-thing/config` with `write_dir` set to `/home/grimlock/work/go-thing/files`.
- Modified `toolserver.go` to implement a secure write_file tool that reads the config and restricts writes to the specified directory.
- Added terminal check to prevent hangs in non-interactive environments.
- Added debug logging for exit condition.
- Confirmed resolution of hanging issue with 'air' after adding terminal check and debug logging.
- UI: Added Account dropdown in the header and moved "Log out" into it. Files updated: `web/src/App.tsx`, `web/src/app.css`.
- Implemented AI follow-up loop for gemini-code-assist bot reviews in GitHub webhook handler.

### Refactor: Move auth/security utilities to utility/ (2025-09-07)
- Backend (file: `agent.go` → package `utility/`)
  - Moved password strength checker to `utility/password.go` as `IsStrongPassword`.
  - Moved CSRF helpers to `utility/security.go`:
    - `NewCSRFToken`, `SetCSRFCookie`, `ValidateCSRF`
    - `IsSecure` and `IsSecureRequest` for TLS/X-Forwarded-Proto detection
    - HMAC helpers `HMACSHA256` and `HMACEqual`
  - Moved session helpers to `utility/session.go`:
    - `SetSessionCookie`, `ClearSessionCookie`, `ParseSession`
  - Updated all references in `agent.go` to use the new utility functions.
  - Updated tests in `agent_github_test.go` to import and use `utility.HMAC*` helpers.
  - Removed unused imports from `agent.go` after extraction.
  - Verified `go build ./...` and `go test ./...` pass.

### Refactor: Extract HTTP routes into routes/ (2025-09-07)
- Backend (file: `agent.go` → package `routes/`)
  - Moved Slack webhook handler to `routes/slack_routes.go` (`RegisterSlackRoutes`) and registered from `main`.
  - Moved GitHub webhook handler to `routes/github_routes.go` (`RegisterGithubRoutes`) and registered from `main`.
  - Moved GitHub direct API caller to `routes/github_routes.go` (`POST /github/call`) and registered from `main`.
  - Moved Signup endpoint to `routes/signup_routes.go` (`RegisterSignupRoutes`) and registered from `main`.
  - Moved Login endpoint to `routes/login_routes.go` (`RegisterLoginRoutes` with injected deps for limiter/session helpers) and registered from `main`.
  - Moved authenticated SSH key generation endpoint to `routes/api_ssh_routes.go` (`RegisterAPISSHRoutes` with injected Docker/ssh-keygen helpers) and registered from `main`.
  - Moved Jira webhook handler to `routes/jira_routes.go` (`RegisterJiraRoutes`) and registered from `main`.
  - Moved Chat handler to `routes/chat_routes.go` (`RegisterChatRoutes`) and registered from `main`.
  - Moved Shell session + WebSocket endpoints to `routes/shell_routes.go` (`RegisterShellRoutes`) and registered from `main` using the existing `wsUpgrader` to preserve the origin policy.
  - Moved Authenticated Settings APIs (profile, password, docker) to `routes/api_settings_routes.go` (`RegisterAPISettingsRoutes`) and registered from `main` via the authenticated `auth` group.
  - Moved Docker SSH key endpoints (download/generate) to `routes/api_docker_routes.go` (`RegisterAPIDockerRoutes`) and registered from `main` with injected Docker helpers and CSRF validation for POST.
  - Moved current user endpoint to `routes/me_routes.go` (`RegisterMeRoutes`) and registered from `main` with `sessionSecret`.
- Rationale: reduce `agent.go` size, improve modularity and testability; route files now encapsulate HTTP logic.
- Status: `go build ./...` and `go test ./...` pass.

### Jira Tools Refactor (2025-09-07)
- Backend (package: `tools/`)
  - Extracted Jira create issue helpers and executor from `tools/jira_issue_ops.go` into `tools/jira_issue_create_ops.go` for separation of concerns:
    - `jiraCreateIssueParams`
    - `parseJiraCreateIssueArgs(...)`
    - `buildJiraCreateIssueBody(...)`
    - `executeJiraCreateIssueTool(...)`
  - Left shared functions in `jira_issue_ops.go` (e.g., `processADFValue`, `jiraDo`) and retained tool registration pointing to the moved executor.
  - No behavior change; build verified.

### Security: WebSocket Origin Allowlist (2025-09-07)
- Backend (file: `agent.go`): Implemented strict origin policy for WebSocket upgrades used by the shell broker.
  - Added `isAllowedWSOrigin(*http.Request) bool` and wired it into `wsUpgrader.CheckOrigin`.
  - Configurable allowlist via INI `[default] ALLOWED_ORIGINS` (comma-separated full origins like `https://app.example.com`).
  - When unset, falls back to same-origin policy using `utility.IsSecure(*http.Request)` to determine `http` vs `https` (proxy-aware via `X-Forwarded-Proto`).
  - Logs a warning on config load failure and defaults to same-origin.
- Rationale: Prevent cross-site WebSocket hijacking (CSWSH) while allowing explicit multi-origin setups.

### Utility: Common helpers for Docker + Auth timing (2025-09-07)
- New file: `utility/common.go`
  - `RunDockerExec(container string, args []string, timeout time.Duration) (stdout, stderr string, err error)`
    - Used by Docker-related routes to execute commands inside the running container with a timeout.
  - `EnsureSSHKeygenAvailable(container string) error`
    - Verifies `ssh-keygen` exists; if missing, installs `openssh` via `pacman` in the Arch-based container, then re-checks.
  - `DummyBcryptCompare(password string)`
    - Generates a per-process dummy bcrypt hash once and compares against it to normalize timing for "user not found" vs "wrong password" cases.
- Wiring changes in routes:
  - `routes.RegisterAPIDockerRoutes(...)` and `routes.RegisterAPISSHRoutes(...)` now receive `EnsureSSHKeygenAvailable` and `RunDockerExec` from `utility`.
  - `routes.RegisterLoginRoutes(...)` now receives `DummyBcryptCompare` to apply timing mitigation when the username is unknown.

### Bugfix (2025-09-07): Jira webhook goroutine parameter
- File: `routes/jira_routes.go`
- Issue: Background goroutine invoked with an empty `systemPrompt` argument, causing `utility.StoreMessage` to persist an empty system message while the actual `promptStr` was only used for the user message. This shadowed the intended value.
- Fix: Change goroutine signature to `func(promptStr, issueKey string)` and invoke it as `(promptStr, issueKey)`, and use `promptStr` for both the system and user messages before calling `GeminiAPIHandler`.

### Refactor (2025-09-07): Centralize Postgres unique violation helper
- New file: `utility/db_errors.go` exporting `utility.IsUniqueViolation(err error) bool` (checks SQLSTATE 23505 via `pgconn.PgError`).
- Removed duplicate local helper from `agent.go` and `routes/signup_routes.go`; updated signup route to call `utility.IsUniqueViolation`.
- Benefit: single source of truth for PG error checks and cleaner imports.

- Cleanup (2025-09-07): Removed a leftover local `isUniqueViolation` helper and unused imports from `agent.go` to complete the refactor.

### Slack App Home Improvements (2025-08-23)
- Robust Home tab publishing with context: `utility.PublishSlackHomeTab(ctx, userID, hash)` uses `slack.PublishViewContextRequest` and retries without hash on `hash_conflict`.
- Home view builder now returns `(view, error)` to surface partial failures (DB fetch issues) while still rendering.
- Escaping + truncation for titles: escape mrkdwn (`&`, `<`, `>`) and truncate to 150 runes via `truncateRunes()`.
- Fallback timestamps are formatted with explicit `UTC` via `slackDateFallbackFormat`.
- Guard total mrkdwn size: define `maxRecentListChars = 2900` and stop appending lines when approaching Slack's 3000-char limit. Count runes, not bytes, using `unicode/utf8` to avoid premature truncation with multi-byte chars. Append `• ... and more` when truncated.
- Minor refactor in `agent.go`: introduced `slackViewInfo` and replaced anonymous nested struct in `slackAppHomeOpenedEvent` for clarity and reuse.

### GitHub Webhook Integration (2025-08-20)
- Security: Added HMAC SHA-256 signature validation for `POST /webhook/github` using `X-Hub-Signature-256` and secret from INI `GITHUB_WEBHOOK_SECRET` (fallback to env).
- Logging: Verbose request diagnostics (headers, body length, raw body capped at 1MB, client IP, query).
- Parsing: Extract common fields (action, repo name/full/id, sender, installation, ref/before/after, pusher).
- Issues events: Extract and log `title`, `body` (truncated to 512 chars), `state`, `labels[].name`, `reactions.total_count` and per-reaction counts, `timeline_url`, and author (`issue.user.login|name`).
- Push events: Detect and log branch, `created` flag, total files added, head commit id/author/message (truncated), plus a sample (up to 10) of added filenames.
- Persistence: Switched to log-only behavior (no DB writes) for webhook events by design; can be re-enabled later behind a flag.
- AI follow-up loop (2025-08-20): In `agent.go` GitHub webhook handler, detect `pull_request_review` and `pull_request_review_comment` authored by `gemini-code-assist[bot]`, extract review/comment body and inline context, and asynchronously invoke `utility.GeminiAPIHandler` with task instructions to apply suggestions and respond `ALL_DONE!` when none remain. Logged results only for now.
  - Logging (2025-08-20): Improved AI loop diagnostics (repo/PR/event IDs, payload sizes, elapsed durations, ALL_DONE detection) and switched to background context with 3m timeout to avoid request-scope cancellations.
  - Fail-fast (2025-08-20): Updated AI task prompt to allow explicit bailout with `GIVING UP: <reason>` when the agent determines it cannot complete the requested changes.
  - Restoration (2025-09-07): After extracting routes into `routes/`, restored the AI follow-up logic inside `routes/github_routes.go`. The `/webhook/github` handler now detects `pull_request_review` and `pull_request_review_comment` events from `gemini-code-assist[bot]`, extracts the review/comment body and PR number, and asynchronously calls `utility.GeminiAPIHandler` with a 3-minute timeout. The response is logged (posting back to GitHub can be added later). This preserves the original behavior that was temporarily lost during refactor.
- Refactor (2025-08-18): DRYed Jira create-issue labels parsing in `tools/jira_issue_ops.go` by introducing a local `addLabel` helper inside `buildJiraCreateIssueBody()` to trim and append non-empty labels from `[]interface{}`, `[]string`, or comma-separated `string`. Behavior preserved.
- Behavior Alignment (2025-08-18): Updated `buildJiraCreateIssueBody()` so user-provided `fields` take precedence over convenience params. Convenience params now apply only when the corresponding key (e.g., `project`, `issuetype`, `summary`, `description`, `labels`, `priority`, `assignee`, `reporter`, `parent`) is absent in `fields`.
- Documented: jira_create_issue now respects --fields precedence over convenience params.
- Small DRY refactor (2025-08-19): Introduced `setQueryFromInt(...)` in `tools/jira_project_ops.go` and replaced repeated int/float64 parsing for `recent`, `startAt`, `maxResults`, and `categoryId` query params. Build passes.
- DRY helper (2025-08-19): Added `getProjectIDOrKey(args)` in `tools/jira_project_ops.go` and refactored repeated `projectIdOrKey` extraction in:
  - `executeJiraGetProjectTool`
  - `executeJiraUpdateProjectTool`
  - `executeJiraDeleteProjectTool`
  - `executeJiraArchiveProjectTool`
  - `executeJiraDeleteProjectAsyncTool`
  - `executeJiraRestoreProjectTool`
  - `executeJiraGetProjectStatusesTool`
  Result: reduced duplication and centralized validation. `go build ./...` passes.
- Consistency (2025-08-19): Added explicit `http.StatusUnauthorized` handling in `tools/jira_project_ops.go` for:
  - `executeJiraProjectsSearchTool` (returns "unauthorized" on 401)
  - `executeJiraGetProjectTool` (401 handling alongside existing 404 check)
  Reason: clearer, consistent error messages across Jira project tools. Build verified.
  - `executeJiraUpdateProjectTool`
  - `executeJiraDeleteProjectTool`
  - `executeJiraArchiveProjectTool`
  - `executeJiraDeleteProjectAsyncTool`
  - `executeJiraRestoreProjectTool`
  - `executeJiraGetProjectStatusesTool`
    Result: reduced duplication and centralized validation. `go build ./...` passes.
   - Consistency (2025-08-19): Added explicit `http.StatusUnauthorized` handling in `tools/jira_project_ops.go` for:
     - `executeJiraProjectsSearchTool` (returns "unauthorized" on 401)
     - `executeJiraGetProjectTool` (401 handling alongside existing 404 check)
     
     Reason: clearer, consistent error messages across Jira project tools. Build verified.

### Gemini Rate Limiting + Retry (2025-08-20)
- Implemented global rate limiting and backoff for Gemini API calls in `utility/gemini.go`.
  - Uses `golang.org/x/time/rate` with default 10 req/min (configurable via `[default] GEMINI_RPM` in `~/.config/go-thing/config.ini`).
  - All calls to `GenerateContent` now `Wait(ctx)` on the limiter before execution and before retries.
  - Added best-effort retry loop for 429/RESOURCE_EXHAUSTED with:
    - Honor server-provided RetryInfo delay if present (e.g., `retryDelay:25s`).
    - Exponential backoff fallback (e.g., 5s, 10s, 20s for 3 attempts), up to 3 attempts.
  - Logs initialization: `[Gemini Rate] Initialized limiter: <rpm> req/min ...`.
  - Aims to prevent errors like: quota exceeded 10 req/min for `gemini-2.5-flash`.
  - Parsing robustness (2025-08-20): Updated `utility/gemini.go` `parseRetryDelay()` to parse `retryDelay:` using `strings.IndexAny` and trim at the first delimiter (space or comma), replacing `strings.Fields` to handle formats like `retryDelay:25s,otherInfo`.
  - Robust 429 detection (2025-08-20): `shouldRetry429()` now first checks for structured `*googleapi.Error` via `errors.As` and `Code == 429`, with string-based fallback for `resource_exhausted`/`429`/`quota`. Added dependency `google.golang.org/api/googleapi`.
  - Maintainability (2025-08-21): Promoted retry/backoff constants to package-level in `utility/gemini.go`:
    - `maxAttempts = 3`
    - `baseDelay = 5 * time.Second`
    Reason: group configuration-like values centrally for easier discovery and future tweaks.
  - Readability (2025-08-21): Flattened nested if/else when parsing `[default] GEMINI_RPM` in `utility/gemini.go` to reduce nesting while preserving behavior (logs parse errors and non-positive values, otherwise sets custom RPM).
  - Safety (2025-08-21): Clamped computed limiter interval to a minimum of `time.Nanosecond` to prevent `rate.Every(0)` (infinite rate) when `GEMINI_RPM` is excessively large. Ensures limiter remains active and log output reflects a valid interval.
  - Safety (2025-08-21): Clamped limiter burst to a maximum (100) to prevent massive initial spikes when `GEMINI_RPM` is very large; logs a warning when clamped.
  - Reliability (2025-08-21): Initially seeded `math/rand` in `agent.go` to randomize backoff jitter; later removed as unnecessary because Go ≥1.20 auto-seeds the global RNG. Cleanup keeps behavior while reducing code.
  - Observability (2025-08-21): Replaced `log.Printf` with structured `slog` in `utility/gemini.go` for machine-readable logs (levels, key-values) across rate limiter init, API send/receive, retries, and context updates.
  - Maintainability (2025-08-21): Introduced `geminiModelName` constant in `utility/gemini.go` and updated the API call to use it (replacing hardcoded model string). Simplifies future model switches and testing.
  - Bugfix (2025-08-21): Corrected indentation of retry delay comment and `delay := ...` declaration inside the `for` retry loop in `utility/gemini.go` to ensure they are within scope; fixes compile error. `go build ./...` passes.
  - Readability (2025-08-21): Replaced magic number in backoff jitter with `backoffJitterMs` package-level constant in `utility/gemini.go`; continues to add up to 1000ms jitter while clarifying intent.
  - Maintainability (2025-08-22): Moved `maxBurst` from a local `const` inside `getGeminiLimiter()` to the package-level `const` block in `utility/gemini.go`, aligning with `maxAttempts`, `baseDelay`, and `backoffJitterMs` for centralized configuration.

  - Refactor (2025-08-22): Extracted `parseRpmFromConfig(cfg map[string]string, defaultRpm int)` from `getGeminiLimiter()` in `utility/gemini.go` to simplify limiter initialization and improve testability. Behavior unchanged: defaults to 10 RPM when unset/invalid; warnings logged on parse/validation issues.

  - Readability (2025-08-22): Introduced `defaultGeminiRpm = 10` constant in `utility/gemini.go` and replaced magic number in `getGeminiLimiter()` to centralize configuration and clarify intent.

### GitHub Webhook typed parsing refactor (2025-08-22)
- File: `agent.go`
- Change: Replaced untyped `map[string]interface{}` parsing for GitHub webhook enrichment with typed structs using `github.com/google/go-github/v66`.
  - Pull requests: use `*github.PullRequestEvent` getters to extract `number`, `title`, `body` (truncated to 512), `state`, `draft`, `user.login`, `html_url`, `head.ref/sha`, `base.ref`, `commits`, `additions`, `deletions`, `changed_files`, `merged`, `mergeable_state`, `merge_commit_sha`.
  - Push: use `*github.PushEvent` to compute `created`, aggregate `added` files across commits (keep up to 10 samples), derive head commit `id/message/author.name` and prefer typed `ref` when available.
- Result: safer parsing, clearer code, and stable logging without brittle type assertions. Behavior matches previous logging but is now strongly typed.
- Dependencies: added `github.com/google/go-github/v66` and `github.com/google/go-querystring v1.1.0` (indirect) to `go.mod`/`go.sum`.

### Jira Issue Comments Tools (2025-08-19)
- Implemented full comment management in `tools/jira_issue_comments.go`:
  - `jira_get_comments_by_ids` → POST `/rest/api/3/comment/list`
  - `jira_list_comments` → GET `/rest/api/3/issue/{issueIdOrKey}/comment`
  - `jira_add_comment` → POST `/rest/api/3/issue/{issueIdOrKey}/comment`
  - `jira_get_comment` → GET `/rest/api/3/issue/{issueIdOrKey}/comment/{id}`
  - `jira_update_comment` → PUT `/rest/api/3/issue/{issueIdOrKey}/comment/{id}`
  - `jira_delete_comment` → DELETE `/rest/api/3/issue/{issueIdOrKey}/comment/{id}`
- Behavior & robustness:
  - Accepts `--issueIdOrKey` (alias: `--issue`).
  - `jira_add_comment` and `jira_update_comment` wrap plain string bodies into minimal Atlassian Document Format (ADF) to avoid 400 errors on Jira Cloud v3.
  - Parses numeric comment IDs from mixed types (float64/int/string/json.Number) for `jira_get_comments_by_ids`.
  - Returns parsed JSON objects and propagates Jira error messages where available for better diagnostics.
- Registered tools in `init()` so they appear in `/api/tools` dynamically.
- Build verified with `go build ./...`.

- Refactor (2025-08-19): Centralized ADF handling for comment bodies by using `processADFValue` in both `jira_add_comment` and `jira_update_comment`. This adds support for string-encoded JSON, reduces duplication, and keeps behavior consistent across add/update paths. Build verified.

- Usability fix (2025-08-19): `jira_get_comments_by_ids` now accepts comma-separated IDs for CLI `/tool` usage (e.g., `--ids 10000,10001`) and still supports native arrays for API clients. Help text updated accordingly.
- Diagnostics (2025-08-19): Added shared Jira error parsing helper to extract `errorMessages` and field-level `errors`. Applied to `jira_add_comment`, `jira_update_comment`, and `jira_delete_comment` so all write ops surface detailed error messages consistently.
- Safety (2025-08-19): Guarded against `int64`→`int` overflow in `jira_get_comments_by_ids` ID parsing to avoid incorrect IDs on 32-bit systems.

## Next Steps
1. Enhance `agent.go` chat interface for better tool integration.
2. Test the write_file functionality.

## PostgreSQL Integration (2025-08-09)
### Goal
- Add internal PostgreSQL support (not exposed as a tool) and run SQL migrations at startup.

### Plan
- Create `db/` package:
  - `postgres.go`: parse `[postgres]` in INI, build DSN, open `database/sql` using `pgx` stdlib driver, ping.
  - `migrate.go`: simple file-based migrations (`schema_migrations` table, lexicographic `.sql` files`).
- Wire into `main()` in `agent.go`: on startup, load INI, init DB, run migrations from `MIGRATIONS_DIR` (default `./migrations`). Continue running even if DB is not configured or connection fails.
- Provide `config.sample.ini` and an example migration under `migrations/`.

### Done
- Implemented `db/postgres.go` and `db/migrate.go`.
- Added `github.com/jackc/pgx/v5` to `go.mod` and `go mod tidy` passes; `go build` succeeds.
- Integrated DB init + `RunMigrations` in `agent.go` startup with logs.
- Added `migrations/0001_init.sql` example file.
- Added `config.sample.ini` with `[postgres]` example.
- Updated README with configuration and migration notes.
 - Added migration CLI in `agent.go`: `migrate up [--step N]`, `migrate down --step N`, `migrate status`.
 - Enhanced migration engine to support `.up.sql`/`.down.sql` conventions, stepwise up/down, and status reporting.
 - Added example down migration `migrations/0001_init.down.sql`.

### Config Key Prefix Rename (2025-08-31)
- Change: Standardized PostgreSQL config keys to use `DB_` prefix in `[postgres]` section.
  - Preferred keys: `DB_DSN` (optional), `DB_HOST`, `DB_PORT`, `DB_USER`, `DB_PASSWORD`, `DB_NAME`, `DB_SSLMODE`, `DB_MIGRATIONS_DIR`.
  - Backward compatibility: Legacy keys remain supported (`PG_DSN`, `HOST`, `PORT`, `USER`, `PASSWORD`, `DBNAME`, `SSLMODE`, `MIGRATIONS_DIR`) and env vars (`PGHOST`, `PGPORT`, `PGUSER`, `PGPASSWORD`, `PGDATABASE`).
- Code: Updated `db/postgres.go` `loadPGConfig()` to prefer new keys with fallbacks; DSN built if not provided.
- Docs/Samples: Updated `config.sample.ini` and `README.md` to show new keys.

### Conversation storage migrations (2025-08-09)
- Added `migrations/0002_conversations_threads_messages.up.sql` to create tables:
  - `threads` (id, title, created_at, updated_at)
  - `messages` (id, thread_id FK, role, content, metadata JSONB, created_at)
- Added `migrations/0002_conversations_threads_messages.down.sql` to drop `messages` then `threads`.
- Indexed `messages(thread_id)` and `messages(created_at)` for common queries.

## Debugging Agent Hanging Issue
The agent hangs when started with 'air' but works with 'go run'. Added detailed logs and flushed output to diagnose. Addressing lint errors (unreachable code, defers). Cause may be Air's signal handling or buffering.

## Task List
- [x] Research Air installation and configuration for Go projects
- [x] Add Air as a development dependency (via binary or config)
- [x] Create or update .air.toml configuration file as needed
- [x] Update documentation with instructions for using Air
- [x] Test hot reloading to confirm it works as expected
- [x] Debug agent hanging issue in agent.go (resolved)
- [x] Fix 'exit' command not stopping the agent (attempt)
- [x] Add logging for input handling and retest
- [x] Add detailed debugging for chat message handling
- [x] Fix Air-specific hanging and lint errors
- [x] Retest with Air

## Changes on 2025-07-27
- Added logging to geminiAPIHandler, chat handler, and main function to improve debugging of tool chaining and API interactions.
- Enhanced system prompt to strictly require JSON for tool calls or Markdown for final responses, ensuring better iterative tool execution.
- Changed configuration file format from JSON to INI format. Updated both agent.go and toolserver.go to use INI parsing with gopkg.in/ini.v1 package. Changed write_dir key to CHROOT_DIR in [default] section.

## Debugging Response Display Issue
- Investigated and added logging to chat handler to fix frontend display issues with Gemini responses.

## Current Goal
Add Jira tools for transitioning issues: list available transitions and perform a transition, wired into the agent tool system. Then test multi-step flows (get transitions -> transition issue).

## Signup Flow + Top Navigation (2025-08-12)
- DB: Added `migrations/0005_users.up.sql` and `.down.sql` creating `users` table with columns `id BIGSERIAL`, `username TEXT UNIQUE` (email), `name TEXT`, `password_hash TEXT`, `created_at`, `updated_at`.
- Backend: Implemented `POST /signup` in `agent.go` that validates inputs, lightly checks email format, enforces min password length, hashes password with bcrypt, and inserts the user (conflict returns 409).
- Frontend: Updated `web/src/App.tsx` to add a top nav (brand + "Sign Up"/"Log In" actions). Implemented a Sign Up modal posting to `/signup`. Added accompanying styles in `web/src/app.css`.
- Build: `go build ./...` passes. Marked configured to synchronous parse to fix TS type.
- Next: Add login/session auth (cookies), password reset, and email verification.

## Login / Session Flow (2025-08-12)
- Backend (file: `agent.go`):
  - Added `POST /login` to authenticate by `username` (email) and `password` using `bcrypt.CompareHashAndPassword` against `users.password_hash`.
  - On success, issues an HttpOnly `session` cookie signed with HMAC-SHA256 over `userID.expiry` using a process `SESSION_SECRET` (from INI `[default]`, fallback ephemeral).
  - Added `POST /logout` to clear the cookie.
  - Added `GET /me` to return `{id, username, name}` for the current session (401 if not logged in).
  - Helpers: `setSessionCookie`, `clearSessionCookie`, `parseSession` and `sessionSecret` initialization (supports `X-Forwarded-Proto` for Secure).
- Frontend (file: `web/src/App.tsx`):
  - Added Login modal (email + password) calling `/login`; shows errors inline; closes on success.
  - Tracks session via `me` state loaded from `/me` on mount; nav shows "Hello, {name}" + "Log Out" when logged in.
  - Added `logout()` calling `/logout` to clear session state.
- Build: `go build ./...` passes.
- Notes: This is a simple cookie-HMAC session; consider CSRF tokens for state-changing endpoints and secure cookie attributes in production.

## User Settings Page (2025-08-23)
- Backend (file: `agent.go`):
  - Added `requireAuth()` middleware to gate authenticated routes by validating the `session` cookie and injecting `userID` into Gin context.
  - Added routes:
    - `GET /api/settings` → returns `{username, name}` for the current user.
    - `POST /api/settings` → updates `users.name` for the current user.
    - `POST /api/settings/password` → verifies current password and updates `users.password_hash`.
  - Security: All POST routes are CSRF-protected via existing `validateCSRF(c)` double-submit token + origin checks. Session cookies continue to be `HttpOnly` with `SameSite=Lax` and `Secure` set when appropriate.
  - DB: Uses existing `users` table (from migrations `0005_users.*`).
- Usage:
  - Settings UI is rendered by the web frontend with path-based routing: navigate to `/account/settings` from the Account menu.
  - Tabs are path segments: `/account/settings` (profile), `/account/settings/password`, `/account/settings/docker`.
  - The server-rendered `GET /settings` route was removed; APIs remain the same.
  - The SPA uses `/csrf` to include `X-CSRF-Token` on writes.
- Build: `go build ./...` passes.

### Frontend Settings (2025-08-23)
- Implemented `SettingsPage` inside `web/src/App.tsx` with hash-based routing (`#/settings`).
- Account dropdown now includes a Settings item that navigates client-side.
- Calls existing APIs: `GET /api/settings`, `POST /api/settings`, `POST /api/settings/password`.

### Settings: Docker Settings Tab (2025-08-31)
- Frontend (`web/src/App.tsx`): Added a tabbed UI to the Settings page with a new "Docker Settings" tab alongside Profile and Password.
- Docker tab currently shows placeholders for container name, image, extra args, and auto-remove. Save is disabled pending backend API.
- No backend changes yet; future work: expose read/write of Docker settings (e.g., DOCKER_CONTAINER_NAME, DOCKER_IMAGE, DOCKER_EXTRA_ARGS, DOCKER_AUTO_REMOVE) via authenticated endpoints with CSRF.
- UI refinement: Moved the Settings tabs into a fixed horizontal toolbar rendered by `App` just under the header; `SettingsPage` now receives `tab`/`onChangeTab` props.
- Accessibility: Increased contrast of the fixed toolbar (dark background, light text, clear active indicator) for readability.

#### Update (2025-09-03): Backend + FE wiring complete
- Backend (`agent.go`): Implemented authenticated Docker settings endpoints using `users.settings` JSONB
  - `GET /api/settings/docker` → returns `{ docker: { container, image, args, auto_remove } }` for the current user
  - `POST /api/settings/docker` → CSRF-protected; upserts `settings->docker` via `jsonb_set` and updates `updated_at`
  - Reused `requireAuth()` and `validateCSRF(c)` patterns; placed routes under `auth := r.Group("/", requireAuth())`
  - Storage: relies on migration `migrations/0007_users_settings.up.sql` which added `users.settings JSONB NOT NULL DEFAULT '{}'`
- Frontend (`web/src/App.tsx`): Wired Docker tab to load on activation and save via `saveDocker()` using `fetchCSRFToken()`
- Status: 404 on `/api/settings/docker` resolved. Form shows persisted values and saves with success/failure messages.
- Next: E2E test in dev, and consider server-side validation for image/container names.

#### Update (2025-09-07): Dockerfile editor
- Backend (`agent.go`): Extended POST `/api/settings/docker` to accept `dockerfile` (string) and persist it to `users.settings->docker.dockerfile`.
- Frontend (`web/src/App.tsx`): Added a `textarea` under Docker Settings to edit the Dockerfile used to build/run the agent container. Value loads from `/api/settings/docker` and saves via the same endpoint.
- Note: We preserve multi-line formatting (no trim) for `dockerfile`. Placeholder shows a minimal Arch-based example.

### SSH Key Generation Feature (2025-08-23)
- Backend (file: `agent.go`):
  - Added authenticated route `POST /api/ssh-keys` inside `auth := r.Group("/", requireAuth())`, placed after the password change handler.
  - Enforces CSRF via `validateCSRF(c)`.
  - Generates keys inside the Docker container: ensures container, ensures `ssh-keygen`, runs keygen, reads keys, and cleans up temp files.
  - Supports `ed25519` (default) and `rsa` with configurable bits (>=2048). Accepts `comment` and optional `passphrase`.
  - Returns JSON: `{ ok, type, bits, public_key, private_key }`.
- Frontend (file: `web/src/App.tsx` → `SettingsPage`):
  - Added form for type, RSA bits, comment, passphrase; `Generate` calls `/api/ssh-keys` with CSRF.
  - Displays public/private keys with copy-to-clipboard and download buttons; hides private key by default.
- Status:
  - Backend `go build ./...` passes; Frontend `npm run build` passes.
  - Manual E2E recommended to verify Docker presence and browser downloads.
- Follow-ups:
  - Add UI toasts on copy; client-side validation for RSA bits.
  - Optional backend/FE tests for the route and form.

#### Update (2025-09-07): Docker SSH key download endpoints + FE hook
- Backend (`agent.go`):
  - Added authenticated routes for Docker container SSH keys:
    - `GET /api/docker/ssh-keys/download?which=public|private` streams `$HOME/.ssh/id_ed25519(.pub)` from the running container as an attachment.
    - `POST /api/docker/ssh-key` generates a fresh ed25519 keypair in `$HOME/.ssh` inside the container and returns the public key.
  - Security: Both routes require a valid session via `requireAuth()` and the POST is CSRF-protected via `validateCSRF(c)`.
  - Robustness: Ensures container is running via `toolsrv.EnsureDockerContainer()` and installs `openssh` if `ssh-keygen` is missing.
  - Maintenance: Removed duplicate route registrations that caused Gin panic ("handlers are already registered"); switched to inline middleware (e.g., `r.POST(..., requireAuth(), handler)`) to avoid undefined `auth` and scope confusion.
- Frontend (`web/src/App.tsx` → `SettingsPage`):
  - Implemented `downloadDockerKey(which)` that fetches the new backend download endpoint and triggers a client download using the existing `download()` helper.
  - Wired the "Download public key" and "Download private key" buttons to this function; fixed the prior `ReferenceError: downloadDockerKey is not defined`.
  - Vite proxy already forwards `/api/*` to the Go server on `127.0.0.1:7866`.
 - Status: Build passes; Air shows routes on startup without duplication; downloads work when keys exist (generate first if needed).

### Minor Security Fix (2025-08-23)
- Restored CSRF validation to `POST /github/call` in `agent.go` and limited request body to 1MB.

## Frontend Refactor (2025-08-13)
- Extracted modal UIs from `web/src/App.tsx` into dedicated components:
  - `web/src/components/LoginModal.tsx`
  - `web/src/components/SignupModal.tsx`
- `App.tsx` now only controls visibility and session `me` state; each modal owns its form state and network calls.
- Benefit: Smaller `App.tsx`, clearer separation of concerns, easier testing and maintenance.
 - Minor polish: In `web/src/App.tsx`, passed `setMe` directly to `LoginModal` as `onSuccess={setMe}` for conciseness.

## Accessibility + DX (2025-08-14)
- Frontend (`web/src/App.tsx`): Removed `aria-hidden` from the Account menu section header so screen readers announce "Account" context in the dropdown.
- Frontend (`web/src/App.tsx`): Added a code comment suggesting extraction of the outside-click/Escape closing logic into a reusable `useOutsideClick` hook for reuse across menus/modals.

### Reusable outside-dismiss hook (2025-08-14)
- Frontend:
  - Implemented `web/src/hooks/useOutsideDismiss.ts` to handle outside click/tap and Escape-key dismissal with optional focus restore.
  - Refactored Account menu in `web/src/App.tsx` to use the hook, removing inline document listeners and simplifying the component.
  - Benefits: better reusability across components, improved accessibility with focus restoration, and reduced code duplication.

## Slack Home Tab Support (2025-08-14)
  - Backend:
    - Added Home tab handling for Slack `app_home_opened` events in `agent.go` route `POST /webhook/slack`.
      - We now unwrap the inner `event` and branch on `type` (`message` vs `app_home_opened`).
      - For `app_home_opened`, we call `utility.PublishSlackHomeTab(userID)` to publish a Home tab view.
    - New helpers in `utility/slack.go`:
      - `BuildSlackHomeView() slack.HomeTabViewRequest` builds a simple Home tab with header, intro, tips, and divider using Block Kit.
      - `PublishSlackHomeTab(userID string) error` uses `slack-go/slack` `PublishView` with the bot token from INI config (`SLACK_BOT_TOKEN`).
    - `go build ./...` passes.
    - Enhancement (2025-08-22): Home tab now shows the last 10 threads from the database. Implemented `fetchRecentThreads(limit)` in `utility/slack.go` using `db.Get()` and rendered a markdown bullet list under a "Recent Threads" section in the Home view.
  - Maintainability (2025-08-23): Introduced `defaultRecentThreadsLimit` constant in `utility/slack.go` to replace magic number `10` in Slack Home tab recent threads logic, used in both `fetchRecentThreads(limit)` defaulting and the call site in `BuildSlackHomeView()`.
  - Maintainability (2025-08-23): Introduced `slackErrorHashConflict` constant (was "hash_conflict") in `utility/slack.go` and updated `PublishSlackHomeTab()` to use it to avoid magic strings when handling Slack view hash conflicts.
  - Robustness (2025-08-23): Escaped special characters `&`, `<`, and `>` in thread titles within `BuildSlackHomeView()` before inserting into the `mrkdwn` list to prevent Slack formatting issues. File: `utility/slack.go`.
  - Consistency (2025-08-23): Fallback timestamp in recent threads now uses `UpdatedAt.UTC()` and appends `" UTC"` to the formatted string to avoid server-local timezone confusion. File: `utility/slack.go`.
  - Reliability (2025-08-23): Plumbed `context.Context` through Slack Home helpers to respect request cancellations and timeouts:
    - `fetchRecentThreads(ctx, limit)` now uses `dbc.QueryContext(ctx, ...)`.
    - `BuildSlackHomeView(ctx)` accepts and passes context through.
    - `PublishSlackHomeTab(ctx, userID, hash)` constructs the view with context.
    - Updated call site in `agent.go` to pass `c.Request.Context()` for `app_home_opened`.
  - Micro-optimization (2025-08-23): Define a package-level `strings.NewReplacer` (`slackMrkdwnEscaper`) to escape mrkdwn (`&`, `<`, `>`) and reuse it across renders, avoiding allocations per call/iteration. File: `utility/slack.go`.
 - Cleanup (2025-08-23): Removed redundant `max == 1` special case in `truncateRunes()`; the general path `string(r[:max-1]) + "…"` already handles it (with `r[:0]` yielding empty string). Behavior unchanged. File: `utility/slack.go`.
  - Performance (2025-08-23): Confirmed `LoadConfig()` already caches using `sync.Once`; removed redundant caching layer from `utility/slack.go` and now call `LoadConfig()` directly in `SendSlackResponse()` and `PublishSlackHomeTab()`.
  - Robustness (2025-08-23): Guarded appending of the trailing summary line (`"• ... and more\n"`) in `BuildSlackHomeView()` so it is only added if it fits within `maxRecentListChars`; prevents exceeding the safety threshold when close to the limit. File: `utility/slack.go`.
  - Refactor (2025-08-23): Extracted recent threads list rendering into `buildRecentThreadsList(threads []threadSummary) string` to reduce nesting and improve readability in `BuildSlackHomeView()`. Behavior unchanged. File: `utility/slack.go`.
  - Slack App configuration required:
    - Scopes: `chat:write` (existing for messages) and `views:write` (new for Home tab).
    - Event Subscriptions: enable Events, add `app_home_opened` to Bot Events, and point Request URL to our `/webhook/slack`.
    - Interactivity not required for this basic Home tab.
### DB Performance Index for Slack Home (2025-08-23)
- Added migrations to index `threads.updated_at` in descending order to speed up queries used by `utility/slack.go` `fetchRecentThreads(...)`:
  - `migrations/0006_add_index_on_threads_updated_at.up.sql`:
    - `CREATE INDEX IF NOT EXISTS idx_threads_updated_at_desc ON threads(updated_at DESC);`
  - `migrations/0006_add_index_on_threads_updated_at.down.sql`:
    - `DROP INDEX IF EXISTS idx_threads_updated_at_desc;`
- Rationale: `SELECT ... FROM threads ORDER BY updated_at DESC LIMIT N` benefits from a matching DESC index as thread count grows, ensuring fast Slack Home tab loads.

## Auth modals type-safety (2025-08-13)
- File: `web/src/components/LoginModal.tsx`
  - Added `LoginSuccess` and `LoginError` types.
  - Parse `res.json()` as `unknown` then assert specific shapes; removed `any` casts.
- File: `web/src/components/SignupModal.tsx`
  - Added `SignupError` type and replaced `any` with typed assertions.
  - Behavior unchanged; improved compile-time safety and readability.

### Type guard refinement (2025-08-13)
- File: `web/src/types.ts`
  - Refactored `isLoginSuccess(d): d is LoginSuccess` to avoid `any`, ensure `d` is a non-null object, and pass `user` as `unknown` to `isUser`.
  - Reason: Improve type-safety and readability while preserving behavior.

### Login handler cleanup (2025-08-13)
- File: `agent.go`
  - Removed redundant empty-username/password check in `POST /login` handler because `binding:"required"` on `loginReq` already rejects empty strings via `c.ShouldBindJSON`.
  - Reason: Unreachable code; simplifies the handler without changing behavior.

## Security + Robustness (2025-08-13)
- Backend (`agent.go`):
  - DRY refactor: extracted `isSecureRequest(c *gin.Context) bool` and used it in both `setSessionCookie()` and `clearSessionCookie()` to consistently set `cookie.Secure` when TLS or `X-Forwarded-Proto=https`.
  - Note: centralizing this logic eases future proxy/trusted-proxy adjustments.
- Frontend:
  - `web/src/components/LoginModal.tsx`: Removed `.catch(() => ({}))` around `res.json()` so malformed JSON surfaces to the outer try/catch, preventing silent failures.
  - `web/src/components/SignupModal.tsx`: Same fix as Login modal for consistent error propagation.
  - CSRF fetch hardening: Guarded `await csrfRes.json()` with a safe parse (`.catch(() => null)`) and optional chaining when reading `token` in both Login and Signup modals to avoid crashes if `/csrf` returns non-JSON or null. Shows a user-facing error instead of throwing.
  - Logout flow: In `web/src/App.tsx`, hardened CSRF token fetch for `/logout` by safely parsing JSON and validating `token` before use; includes HTTP status in error for better diagnostics.
  - `web/src/App.tsx`: Introduced `User` type and `isUser(o): o is User` type guard; simplified `/me` loader check and updated `me` state to `User | null`.
  - Benefit: safer runtime checks, cleaner code, and fewer brittle `any` casts.

### CSRF Protection for Auth Endpoints (2025-08-13)
- Backend (`agent.go`):
  - Added double-submit CSRF defense.
  - Added helpers: `newCSRFToken()`, `setCSRFCookie(...)`, and `validateCSRF(c)` which enforces same-origin (when `Origin` present) and requires `X-CSRF-Token` to match the `csrf_token` cookie in constant-time.
  - Enforced CSRF validation on `POST /login` and `POST /logout`.
- Frontend action items:
  - Before calling any state-changing endpoint, call `GET /csrf`, then include `X-CSRF-Token: <token>` header on requests. Ensure credentials/cookies are sent (fetch with `credentials: 'include'`).
  - Update login/logout flows in `web/` to fetch the token and send the header.
  - Implemented: Updated `web/src/components/LoginModal.tsx` `login()` to fetch `/csrf`, include `X-CSRF-Token` and `credentials: 'include'` on the `/login` POST.
  - Note: Session cookie remains `SameSite=Lax`; CSRF cookie is `SameSite=Strict`.
  - Note: Login flow was updated to fetch and send CSRF token.
  - Implemented: Updated `web/src/App.tsx` `logout()` to fetch `/csrf`, include `X-CSRF-Token` and `credentials: 'include'` on the `/logout` POST.
  - Note: Session cookie remains `SameSite=Lax`; CSRF cookie is `SameSite=Strict`.

### Frontend CSRF helper refactor (2025-08-13)
- Added shared helper `web/src/utils/csrf.ts` exporting `fetchCSRFToken()` that:
  - Calls `/csrf` with `credentials: 'include'`.
  - Safely parses JSON and validates `token` as a non-empty string; throws descriptive errors otherwise.
- Refactored components to use the helper instead of inline parsing:
  - `web/src/components/LoginModal.tsx` (login flow)
  - `web/src/components/SignupModal.tsx` (signup flow)
  - `web/src/App.tsx` (`logout()`)
- Benefit: removes duplication, improves type safety/readability, and standardizes error messages for CSRF retrieval.

#### CSRF helper type-safety tweak (2025-08-13)
- File: `web/src/utils/csrf.ts`
- Change: Replaced `(data as any)?.token` with explicit structural checks on the parsed JSON (`unknown` -> object with non-empty string `token`).
- Reason: Avoid `any` and enforce stronger compile-time guarantees while preserving existing runtime behavior.

### Login timing-attack comment clarification (2025-08-13)
- File: `agent.go` (`POST /login` handler, non-existent user branch)
- Change: Expanded the inline comment above `dummyBcryptCompare(p)` to explicitly state it mitigates username-enumeration timing attacks by performing a dummy bcrypt comparison when the user is not found.
- Reason: Improve maintainability and security clarity for future reviewers; behavior unchanged.

### Bcrypt timing mitigation hardening (2025-08-13)
- File: `agent.go` (`dummyBcryptCompare`)
- Change: Removed sleep-based fallback and now fail fast with `log.Fatalf` if `bcrypt.GenerateFromPassword(...)` for the dummy hash ever fails. The dummy hash is generated once at startup (via `sync.Once`) and subsequent calls always perform `CompareHashAndPassword` against the dummy.
- Reason: Avoids observable timing discrepancies between "user not found" and "wrong password" when dummy hash generation fails; ensures the app never runs in a degraded security posture.
- Result: Consistent constant-time-ish behavior for auth failure paths and simpler logic.

### Login rate limiter cleanup concurrency fix (2025-08-13)
- File: `agent.go` (`loginRateLimiter.cleanup`)
- Change: Use single-lock, in-place pruning of stale entries instead of the prior copy-and-swap approach.
- Reason: Copy-and-swap introduced a race window where concurrent mutations (e.g., `getLimiter`, `recordFailure`, `recordSuccess`) could be lost between unlock/swap, dropping recent limiters or failure states. Cleanup runs infrequently (every ~10m), so brief contention is acceptable to guarantee correctness.
- Result: Correctness over minimal lock time; avoids losing recent limiter/failure updates during cleanup.

## Changes on 2025-08-08
- Refactored tools to be modular with dynamic discovery/dispatch:
  - Introduced a registry-based dispatcher in `tools/toolserver.go` using `toolExecutors` and `tools` maps.
  - Moved `disk_space` implementation to `tools/disk_space.go` and registered via `init()`.
  - Moved `write_file` implementation to `tools/write_file.go` and registered via `init()`.
  - Simplified `toolserver.go` to keep shared types, HTTP handlers, and empty registries.

- Updated `agent.go` to discover and execute tools dynamically via the tool server, now embedded in-process:
  - `getAvailableTools()` now calls `GET http://127.0.0.1:8080/api/tools` and renders the dynamic list.
  - `executeTool()` now posts tool calls to `POST /api/tools` and returns the server response.
  - The Gemini system prompt's "Available Tools" section is built at runtime from the live registry (so new tools like `jira_search_issues` are immediately usable without agent changes).
  - Implemented `/tool` command parsing to delegate execution to the tool server and `/tools` to list the live set.

### Jira Transitions Tools (2025-08-08)
- Added `jira_get_transitions` tool to fetch available transitions for an issue, supporting query params: `expand`, `transitionId`, `skipRemoteOnlyCondition`, `includeUnavailableTransitions`, `sortByOpsBarAndStatus`.
- Added `jira_transition_issue` tool to perform a transition, supporting body keys: `transition`, `fields`, `update`, `properties`, `historyMetadata` and convenience `transitionId`.
  - Registered both tools in `tools/jira_issue_ops.go` with help text and parameters.

### Refactor: Jira create issue executor (2025-08-18)
- File: `tools/jira_issue_ops.go`
- Change: Split `executeJiraCreateIssueTool()` into smaller helpers for maintainability/testability:
  - `parseJiraCreateIssueArgs(args)`: parses/validates `map[string]interface{}` into a dedicated params struct and validates JSON string passthrough for `update/properties/historyMetadata/transition` and `fields`.
  - `buildJiraCreateIssueBody(params)`: builds the final Jira request body, preserving ADF wrapping, priority/labels handling, and id-vs-name/id-vs-key preferences.
  - Main function now orchestrates parse -> build -> `jiraDo` while preserving existing behavior and error messages.
- Result: Same functionality with clearer separation of concerns; `go build ./...` passes.
  - DRY improvements: centralized string-based convenience params parsing via a `stringParams` map+loop; consolidated optional top-level JSON-capable keys (`update`, `properties`, `historyMetadata`, `transition`) handling via a loop over pointers with validation. Expanded label parsing loops to multi-line for readability. Build verified.
  - Labels: Trim once per element and reuse the result across checks/appends in `buildJiraCreateIssueBody()` to avoid duplicate `strings.TrimSpace` calls for `[]interface{}`, `[]string`, and CSV `string` inputs. Behavior unchanged; readability and micro-efficiency improved. Build verified.

#### Follow-up hardening (2025-08-18)
- Nil-guard for `fields` parsing in `parseJiraCreateIssueArgs` so a JSON `null` or nil map does not overwrite the initialized map and cause panics during body construction.
- Replaced mutating `handleADFField` helper with pure `processADFValue(raw) (interface{}, bool)` and updated `buildJiraCreateIssueBody` to set `environment` and `description` via the returned value.
- Benefit: safer map handling and improved reusability/testability of ADF logic. Build verified with `go build ./...`.

### Developer Experience Improvements
- The tool server has been converted into a reusable package (`tools`) and is now started inside `agent.go` (as a goroutine) on `:8080`. Running `air` in the project root starts BOTH the agent and the tool server automatically.
- No need to run a separate tool server process.
 
## Next Steps (Follow-up)
1. Encourage the agent to call `jira_get_transitions` before `jira_transition_issue` when transition id is unknown (prompt hint or chain-of-thought hinting via tool loop).
2. Add basic unit tests for the two executors.
3. Validate `GET /api/tools` lists the new tools and `POST /api/tools` dispatch works end-to-end.
4. Add an integration test for `agent.go` multi-step flow (list transitions then transition).
5. Document required config for all Jira tools (`JIRA_URL`, `JIRA_TOKEN`, optional `JIRA_EMAIL`).

## Frontend (React + Vite) and Cloudflare Workers Deployment (2025-08-08)
- Added a new React + Vite frontend under `web/` with minimal scaffolding (`index.html`, `src/main.tsx`, `src/App.tsx`, `tsconfig.json`, `vite.config.ts`).
- Added `wrangler.toml` at the repo root configured to deploy the built SPA via Workers Static Assets with SPA routing fallback:
  - `[assets] directory = "./web/dist"`
  - `not_found_handling = "single-page-application"`
  - `name = "go-thing-frontend"`, `compatibility_date = "2025-08-01"`.
- Updated `web/package.json` to include `@vitejs/plugin-react` for the Vite React plugin.

### Developer commands
- Install deps: `npm install` (in `web/`).
- Local dev: `npm run dev` (in `web/`).
- Build: `npm run build` (in `web/`).
- Preview build locally: `npm run preview` (in `web/`).
- Deploy to Workers (from repo root where `wrangler.toml` lives): `npx wrangler deploy`.

### Notes
- The Workers deployment uses Static Assets with SPA routing (`single-page-application`) so unknown navigation paths fall back to `index.html`.
- Backend/API integration can be added later via a Worker `main` script or by exposing your existing Go server behind an `/api` origin and proxying from the Worker.
- Vite dev server configured to allow the stage host by setting `server.allowedHosts = ['gothing.stage.portnumber53.com']` in `web/vite.config.ts` to fix blocked host errors when accessing via the staging domain.
- Vite dev server port changed from 5173 to 5174 via `server.port = 5174` in `web/vite.config.ts`.
 - Vite proxy targets updated from `127.0.0.1:7866` to `127.0.0.1:7866` for `/chat` and `/webhook` in `web/vite.config.ts`.

### Cleanup (2025-08-08)
- Removed the embedded HTML/JS chat UI from `agent.go` (`GET /`). The endpoint now returns a JSON health/info payload.
- The React/Vite SPA under `web/` is the only UI moving forward. During local dev, Vite proxies `/chat` and `/webhook` to `127.0.0.1:7866`.
- For production, build the SPA (`web/dist`) and deploy via Cloudflare Workers (configured in `wrangler.toml`).

## Jira User Tools (2025-08-09)
- Implemented multiple Jira user-management tools in `tools/jira_users.go`, registered via `init()` so the agent discovers them dynamically:
  - `jira_users_all` (GET /rest/api/3/users/search)
  - `jira_users_assignable_multi` (GET /rest/api/3/user/assignable/multiProjectSearch)
  - `jira_users_assignable` (GET /rest/api/3/user/assignable/search)
  - `jira_users_permission_search` (GET /rest/api/3/user/permission/search)
  - `jira_user_picker` (GET /rest/api/3/user/picker)
  - `jira_users_search` (GET /rest/api/3/user/search)
  - `jira_users_search_query` (GET /rest/api/3/user/search/query)
  - `jira_users_search_query_key` (GET /rest/api/3/user/search/query/key)
  - `jira_users_viewissue_search` (GET /rest/api/3/user/viewissue/search)

### Notes
- All tools read `JIRA_URL`, `JIRA_TOKEN`, and optional `JIRA_EMAIL` from the INI config (`[default]` section).
- Responses prefer simplified user fields when possible and fall back to raw JSON for resiliency.
- HTTP logs mask Authorization headers and truncate large bodies.

### Next Steps
1. Add unit tests for each executor with mocked HTTP.
2. Provide usage examples in the system prompt so Gemini can pick the correct user tool.
3. End-to-end test via `/tool` posts and through the chat tool loop.
4. Optionally add POST variants where Jira supports it (if needed for large queries).

## shell_exec Tool (2025-08-09)
- Added `tools/shell_exec.go` implementing a secure shell execution tool constrained to `CHROOT_DIR`.
- Behavior:
  - Executes `/bin/sh -lc "<command>"` with working directory defaulting to `CHROOT_DIR` or a validated subdirectory `--workdir`.
  - Enforces chroot boundary using `filepath.Abs`, `Clean`, and `Rel` checks (same pattern as `read_file`/`write_file`).
  - Supports `--timeout_sec` (default 60s, clamped to [1, 600]).
  - Returns `{ stdout, stderr, exit_code, workdir, command }` and treats non-zero exit as successful call with exit_code for caller inspection.

### Prompt/Agent
- No prompt changes required. The agent discovers the tool dynamically and lists it in the “Available Tools” section for Gemini.

### Next Steps
1. Add tests covering: workdir validation, timeout behavior, non-zero exit handling, and output capture.
2. Document usage in README with examples and CHROOT guidance.
3. Optionally add environment variable allowlist for commands if needed later.

## docker_start Tool (2025-08-09)
- Added `tools/docker_start.go` to start an Arch-based Docker container with the configured `CHROOT_DIR` mounted at `/app` inside the container.
- Behavior:
  - Runs `docker run -d --name <name> -v CHROOT_DIR:/app -w /app <image> sleep infinity`.
  - Defaults: `name=go-thing-arch`, `image=archlinux:latest`. Optional `--extra_args` pass-through for advanced flags.
  - Validates `CHROOT_DIR` from `~/.config/go-thing/config.ini` `[default]` section.
- Usage examples:
  - `/tool docker_start`
  - `/tool docker_start --name my-arch --extra_args "--privileged"`

### Next Steps
1. Add a complementary `docker_exec` helper to run a command inside the container (e.g., `docker exec -it <name> bash`).
2. Add a `docker_stop`/`docker_rm` tool for lifecycle management.
3. Document prerequisites (Docker installed, user in docker group) in README.

## Docker Sandbox + Lifecycle Integration (2025-08-09)
- Sandbox: `shell_exec` now runs inside an Arch Linux Docker container via `docker exec`, mapping `CHROOT_DIR` from the host to `/app` in the container and translating working directories accordingly. This isolates filesystem-touching commands from the host.
- Lifecycle helpers:
  - `StopDockerContainer()` and `RemoveDockerContainer(force bool)` added in `tools/docker_start.go`.
  - Added internal `dockerStop(name string)` helper.
- Agent shutdown: `agent.go` now best-effort stops the container on SIGINT/SIGTERM, and removes it when `[default] DOCKER_AUTO_REMOVE=true` in `~/.config/go-thing/config.ini`.
- Config sample: Added commented `DOCKER_AUTO_REMOVE` key to `config.ini.sample`.

Next:
1. Add tests for lifecycle helpers and `shell_exec` Docker execution path.
2. Document Docker prerequisites and usage in README (including `CHROOT_DIR` mapping and optional `DOCKER_EXTRA_ARGS`).
3. Consider explicit admin tool endpoints to stop/remove the container manually if needed.

## Interactive Shell Broker (2025-08-11)
### Goal
- Provide persistent interactive shells inside the Docker container that multiple clients can share concurrently (Agent logic, browsers, third-party apps), while maintaining shell state across commands.

### Implementation
- Added `tools/shell_broker.go` implementing a broker and `ShellSession`:
  - Single docker `bash` per session via `docker exec -it -w <workdir> <container> /bin/bash`.
  - Input multiplexing: session `inputQueue chan []byte` serializes all inputs.
  - Output broadcasting: subscribers per session receive real-time stdout/stderr.
  - Lifecycle: `CreateOrGet(id, subdir)`, `List()`, `Close(id)`; graceful shutdown on agent exit.
- Extended `agent.go` with REST + WebSocket endpoints:
  - `GET /shell/sessions` list active session IDs.
  - `POST /shell/sessions {id, subdir}` create or get a session; `subdir` maps under `CHROOT_DIR` to `/app/<subdir>`.
  - `DELETE /shell/sessions/:id` close a session.
  - `GET /shell/ws/:id` WebSocket to attach: send text/binary as input; receive binary output frames.
- Reused existing Docker lifecycle from `tools/docker_start.go` (`EnsureDockerContainer`) and chroot mapping to `/app`.

### Usage Examples
- Create a session targeting repo root and attach from a browser or app:
  1) `POST /shell/sessions {"id":"dev","subdir":""}`
  2) Connect WebSocket to `/shell/ws/dev`, then send commands like `ls -la` (newline auto-appended server-side).
- Multiple clients can connect to the same session and see shared state/output.
- Create separate sessions for long-running processes (e.g., server logs) while continuing interactive work in another.

### Notes
- Output frames are raw terminal bytes (TTY enabled); clients should render appropriately (xterm.js recommended).
- Inputs are newline-terminated if not already; for interactive UIs, send full lines.
- Env for the shell is cleared for safety; container provides environment.

### Enhancements (2025-08-11)
- Switched Docker exec bash sessions to use a real PTY via `github.com/creack/pty` in `tools/shell_broker.go`, fixing the "input device is not a TTY" issue and enabling proper interactive behavior.
- Improved sentinel-based parsing in `tools/shell_session_tool.go`:
  - Wrap commands with unique start/end sentinels using `printf` and normalize newlines.
  - Strip ANSI escape sequences from PTY output before parsing to avoid control code interference.
  - Anchor sentinel detection on line boundaries and handle split-chunk accumulation.
- Added post-command PWD sentinel so the tool returns the effective working directory:
  - Emits a `__PWD__<tag><cwd>` line between start and end sentinels using `printf '%s%s\n'` with `$(pwd)`.
  - Response data now includes `cwd` (effective after the command) in addition to `workdir` (initial session dir) and `output`.
  - Fallback logic retains partial output if the end sentinel isn't observed within timeout.

### Fix (2025-08-12)
- File: `tools/shell_session_tool.go`
- Change: Replaced `extractCwdAndTrim` logic to split output by lines, find the last PWD sentinel line, remove only that line, and rejoin the rest.
- Reason: Previous implementation could truncate output after the sentinel when it appeared mid-stream, causing data loss.
- Result: Preserves all legitimate output while still extracting `cwd`. Build verified with `go build ./...`.

### Minor Simplification (2025-08-12)
- File: `tools/shell_session_tool.go`
- Change: Removed redundant inner `if len(s) > tailKeep` in large-output tail handling since the outer `if acc.Len() > tailKeep` guarantees it.
- Reason: Simplify logic without changing behavior.
- Result: Cleaner code; build verified.

### Readability Simplification (2025-08-12)
- File: `tools/shell_session_tool.go`
- Change: Simplified final `cwd` resolution after `extractCwdAndTrim(...)` by directly assigning `cwdDetected = cwd` with a fallback to `sess.Workdir`.
- Reason: Improve clarity and reduce conditional verbosity without changing behavior.
- Result: Same behavior with clearer intent; build verified with `go build ./...`.

### End Sentinel Robustness (2025-08-12)
- File: `tools/shell_session_tool.go`
- Change: Removed fallback detection of `endMark` without a preceding newline. Now we only consider the newline-anchored pattern (`"\n"+endMark`).
- Reason: The wrapped command emits sentinels via `printf` with trailing `\n`, so the end sentinel will always be on its own line. The fallback could prematurely truncate output if the command's output happened to contain the sentinel string.
- Result: More robust capture avoiding accidental truncation; behavior aligns with sentinel emission guarantees. Build verified.

### Concurrency Fix (2025-08-12)
- File: `tools/shell_broker.go`
- Change: Added `writeMu sync.Mutex` to `ShellSession` and guarded `write()` to serialize writes to the PTY.
- Reason: Prevent potential race between the writer loop (input queue) and `Close()` sending `exit\n`.
- Result: Eliminates concurrent writes to the TTY; `go build ./...` passes.

### Security + Readability (2025-08-12)
- File: `tools/shell_broker.go`
- Changes:
  - Refactored `Subscribe()` and `Unsubscribe()` to use clear lock/defer-unlock patterns instead of dense one-liners.
  - Removed raw payload from PTY read logging to avoid secret leakage; now only logs byte count.
- Reason: Improve maintainability and prevent accidental exposure of sensitive output in logs.
- Result: Build verified with `go build ./...`.

### Subscriber Notification Fix (2025-08-12)
- File: `tools/shell_broker.go`
- Change: In `ShellSession.Close()`, close all subscriber channels under `subsMu` and clear the `subscribers` map.
- Reason: Prevent goroutine leaks in WebSocket handlers waiting on now-orphaned channels when a session terminates.
- Result: Subscribers are unblocked promptly; safe against races with `Unsubscribe`.

### WebSocket Writer Leak Fix (2025-08-12)
- File: `agent.go`
- Change: In shell WS writer goroutine, on `WriteMessage` error, log and explicitly `conn.Close()` before signaling done. Ensures the reader loop unblocks (ReadMessage returns) and the handler exits cleanly.
- Reason: Prevent goroutine leaks when the writer fails but the reader remains blocked.
- Result: Graceful termination of both goroutines on write errors; build verified.

### WebSocket Close-on-Session-Closed (2025-08-12)
- File: `agent.go`
- Change: When the shell session's `outCh` closes (e.g., session deleted or server shutdown), the writer goroutine now also calls `conn.Close()` after sending `[session closed]`.
- Reason: Proactively close the WebSocket to unblock the reader goroutine and avoid resource leaks while waiting for heartbeat timeouts or client disconnects.
- Result: Handler terminates cleanly on session closure; no lingering connections. Build verified.

### WebSocket Write Serialization (2025-08-12)
- File: `agent.go` (`GET /shell/ws/:id`)
- Change: Introduced a shared `sync.Mutex` (`writeMu`) and guarded all `conn.WriteMessage` calls in both the writer goroutine and the read loop (including session-closed notice and backpressure Close frame).
- Reason: gorilla/websocket forbids concurrent writes; previous code could race between the writer and read loop writes, causing panics/data corruption.
- Result: All WS writes are serialized; race eliminated. Build verified with `go build ./...`.

### Backpressure: Non-blocking Enqueue (2025-08-12)
- Files: `tools/shell_broker.go`, `agent.go`, `tools/shell_session_tool.go`
- Change: Made `ShellSession.Enqueue([]byte) bool` non-blocking; it returns `false` when the input queue is full. The WebSocket handler now detects a full queue, sends a `[backpressure]` notice to the client, and drops the input. The shell session tool returns a `ToolResponse` error so callers can retry.
- Reason: Prevent blocking the WebSocket read loop when a fast client overwhelms a slow shell, avoiding resource leaks and DoS risk.
- Result: Backpressure is handled gracefully without stalling; `go build ./...` passes.

### WebSocket Heartbeat + Close-on-Backpressure (2025-08-12)
- File: `agent.go`
- Change: Added read deadlines and a `SetPongHandler` to implement a 60s heartbeat for `/shell/ws/:id`. On input-queue saturation, the server sends a Close frame (PolicyViolation) and exits the loop.
- Reason: Detect dead clients to prevent goroutine leaks and fail fast under sustained backpressure instead of stalling.
- Result: Healthier WS connections; handlers terminate promptly on dead peers or overload. Build passes.

### Next Steps
1. Authentication/authorization for `/shell/*` endpoints; session ACLs/read-only mode.
2. Optional session TTL/idle timeout and explicit `stop/remove` container admin endpoints.
3. Client focus/lock semantics to avoid interleaved typing conflicts.
4. Structured event protocol (JSON frames) optionally wrapping raw stream for metadata.
5. Persist minimal session metadata in DB if needed.

## Current Context Memory (2025-08-10)
### Goal
- Let the model maintain a concise rolling context in JSON under `current_context` (and accept legacy `current_content`), and have the agent persist and resend it on future turns.

### Changes
- Updated `agent.go`:
  - `callGeminiAPI(...)` now receives `persistedContext []string` and injects a "Persisted Context (current_context)" section into the system prompt. Path: `agent.go` function `callGeminiAPI()`.
  - System prompt updated to instruct the model to optionally include `current_context` in tool-call JSON, with guidance to pick/prune only high-signal facts (<= 8 items). Path: `agent.go` in `callGeminiAPI()` system prompt assembly.
  - Extended `ToolCall` struct to parse `current_context` and `current_content` arrays. Added helper `GetMergedContext()` and `mergeStringSets()` to dedupe and merge. Path: `agent.go`.
  - `geminiAPIHandler(...)` now maintains a rolling `currentContext []string`, merges new context from each tool-call JSON, and passes it back into `callGeminiAPI(...)` on subsequent iterations. Path: `agent.go`.

### Behavior
- Model may return tool-call JSON like:
  ```json
  {"tool":"write_file","args":{"path":"/app/repo/README.md","content":"..."},"current_context":["the working dir is /app/repo/","you're using Arch, btw, as root","you can install whatever you need","the last packages installed was npm and nodejs"]}
  ```
- Agent extracts `current_context` (and `current_content` if present), merges/dedupes, keeps up to the last 8 facts, and includes them in subsequent prompts.
- Final Markdown responses are unchanged; only tool-call JSON may include the optional `current_context` key.

### Notes
- Build verified: `go build ./...` succeeds.
- Also removed a duplicate/partial `geminiAPIHandler` definition and a stray line in `processUserMessage()` to fix syntax lints.

## Performance Optimization (2025-08-10)
- Precompiled the double-slash collapsing regex at the package level in `agent.go` as `doubleSlashRegex` and refactored `normalizePathInText()` to reuse it, avoiding recompilation on every call.
- Affected code:
  - Function: `normalizePathInText()` in `agent.go`
  - Variable: `doubleSlashRegex = regexp.MustCompile(([^:])//+)` defined at package scope
  - Benefit: Minor reduction in CPU and allocations when normalizing many strings (hot path for context and messages).
- Also pre-allocated the result slice in `mergeStringSets()` in `agent.go` using `make([]string, 0, len(base)+len(extra))` to reduce allocations during context merging.

## Slack Error Handling Fix (2025-08-10)
- Fixed regression in `handleSlackMessage()` where errors from `geminiAPIHandler(...)` were logged but processing continued.
- New behavior: on error, log, send a friendly Slack message ("Sorry, I encountered an error. Please try again."), respond to HTTP with `{status: "error_processed"}`, and `return` early to avoid persisting/sending invalid replies.
- Affected code: `agent.go` function `handleSlackMessage()`.

## Error Propagation Fix (2025-08-10)
- In `geminiAPIHandler(...)`, errors returned by `callGeminiAPI(...)` were logged but suppressed by returning `nil` as the error value.
- Update: now returns the original `err` to the caller and an empty message string: `return "", currentContext, err`.
- Impact: callers (e.g., HTTP handlers, Slack handler) can correctly detect failures and handle them instead of proceeding as if successful.

## Request Context Propagation (2025-08-10)
- Updated `agent.go` `handleSlackMessage()` to pass `c.Request.Context()` into `geminiAPIHandler(...)` instead of `context.Background()`.
- Benefit: respects client disconnect/cancellation and avoids orphaned work; aligns with best practices for request-scoped cancellation in Gin.

## Config Read Optimization (2025-08-10)
- Cached `CURRENT_CONTEXT_MAX_ITEMS` using `sync.Once` and a package-level variable in `agent.go`'s `getContextMaxItems()`.
- Rationale: avoid repeated config file access and string parsing inside the `geminiAPIHandler` loop (hot path).
- Note: value is fixed for process lifetime (consistent with config load via `sync.Once`).

## Minor Refactor (2025-08-10)
- Simplified `ToolCall.GetMergedContext()` to directly return `mergeStringSets(tc.CurrentContext, tc.CurrentContent)`.
- Rationale: reduce verbosity; `mergeStringSets` already handles empty/nil slices.

## Security Improvement (2025-08-10)
- In HTTP `/chat` handler, replaced detailed error echo (`fmt.Sprintf("... %v", err)`) with a generic message to avoid leaking internal details.
- Logs still record the full error for debugging; clients receive: "Failed to process message. Please try again later."

## Path Normalization + Config Cache (2025-08-10)
- Cached `CHROOT_DIR` using `sync.Once` (`chrootDirOnce`, `chrootDirCached`) to avoid repeated lookups in the hot path `normalizePathInText()`.
- Fixed a regression by restoring `normalizePathInText(s string) string` return signature and proper returns of `s`/`s2`.

## DB Index Optimization (2025-08-10)
- Added composite index for query optimizing latest assistant message lookups:
  - Up: `migrations/0004_messages_thread_role_id_idx.up.sql`
    - `CREATE INDEX IF NOT EXISTS idx_messages_thread_role_id_desc ON messages (thread_id, role, id DESC);`
  - Down: `migrations/0004_messages_thread_role_id_idx.down.sql`
    - `DROP INDEX IF EXISTS idx_messages_thread_role_id_desc;`
- Rationale: speeds up `getLastContextForThread()` in `agent.go` which filters by `thread_id` and `role` and orders by `id DESC LIMIT 1`.

## Small Refactor (2025-08-10)
- Extracted path normalization helpers from `agent.go` into `path_normalize.go`:
  - Moved: `doubleSlashRegex`, `normalizePathInText()`, `sanitizeContextFacts()`.
  - Kept `getChrootDir()` in `agent.go` (shared cache), used by `path_normalize.go`.
- Cleaned up imports in `agent.go` (retained `regexp` as it is used by `/tool` parsing).
- Benefit: smaller `agent.go`, clearer separation of concerns.

## Context Utils Refactor (2025-08-10)
- Moved context-related helpers from `agent.go` to a new `utility_context.go` for maintainability:
  - `getLastContextForThread(threadID int64) ([]string, error)`
  - `getContextMaxItems() int` (with `sync.Once` cache vars)
  - `mergeStringSets(base, extra []string) []string`
- Cleaned imports and removed duplicate cache vars from `agent.go`.
- Verified with `go build ./...`.

## Gemini Refactor (2025-08-10)
- Extracted Gemini-specific logic from `agent.go` to `gemini.go`:
  - `callGeminiAPI(...)`
  - `geminiAPIHandler(...)`
  - `ToolCall` struct and `GetMergedContext()` method
- Cleaned up imports and removed duplicates from `agent.go`.
- Build verified: `go build ./...`.

## Robustness Fixes (2025-08-11)
- Updated `utility/tools.go` `ExecuteTool()` to improve reliability and error propagation:
  - Handle `json.Marshal` error for the request payload and return a wrapped error.
  - Use `bytes.NewReader` for HTTP request body instead of converting to string.
  - Replace deprecated `ioutil.ReadAll` with `io.ReadAll` and handle its error.
  - Return a clear error on non-2xx HTTP responses (include status and body snippet).
- Imports updated to use `bytes` and `io`; removed deprecated `ioutil` import.
- Verified with `go build ./...`.

### Follow-up (2025-08-10)
- Moved Slack helpers/handlers under `utility/` to reduce top-level clutter and decouple from `main` internals:
  - `utility/slack.go`: `SendSlackResponse()`
  - `utility/slack_handlers.go`: `HandleSlackMessage(...)` with injected deps (`getOrCreateAnyThread`, `geminiAPIHandler`).
- Updated `agent.go` webhook route to call `utility.HandleSlackMessage(...)`.
- Replaced top-level `slack.go` with a minimal stub comment (no code).
- Build verified: `go build ./...`.

## Misc & DB Utilities Refactor (2025-08-10)
- Extracted generic helpers to `utility_misc.go`:
  - `summarizeToolResponse()`
  - `maskToken()`
- Extracted DB helpers to `utility_db.go`:
  - `createNewThread(title string) (int64, error)`
  - `storeMessage(threadID int64, role, content string, metadata map[string]interface{}) error`
- Removed moved functions from `agent.go` and cleaned imports.
- Build verified: `go build ./...`.

## Config & Logging Utilities Refactor (2025-08-10)
- Extracted configuration helpers to `utility_config.go`:
  - `loadConfig()`
  - `getChrootDir()`
  - Moved related cached variables (`configOnce`, `configData`, `configErr`, `chrootDirOnce`, `chrootDirCached`) and `dockerAutoRemove` handling.
- Extracted logging setup to `internal/logging/logging.go`:
  - `logging.Setup()` writes to stdout and `debug.log`, routes Gin logs as well.
  - Removed old `setupLogging()` from `utility_logging.go` (now a stub pointing to internal).
- Removed moved functions/vars from `agent.go` and cleaned imports.
- Build verified: `go build ./...`.

### Follow-up (2025-08-10)
- Removed obsolete `utility_logging.go` after migrating to `internal/logging/logging.go` to avoid duplication.
- Build verified: `go build ./...`.

### Follow-up (2025-08-10)
- Moved misc helpers to `utility/misc.go` as package `utility` with exported functions:
  - `SummarizeToolResponse(success bool, data interface{}, errMsg string) string`
  - `MaskToken(s string) string`
- Updated `gemini.go` to import `go-thing/utility` and use `utility.SummarizeToolResponse`.
- Moved DB helpers to `utility/db.go` as package `utility` with exported functions:
  - `CreateNewThread(title string) (int64, error)`
  - `StoreMessage(threadID int64, role, content string, metadata map[string]interface{}) error`
- Updated call sites in `agent.go` and `slack.go` to use `utility` package.
- Removed `utility_misc.go` and `utility_db.go` to avoid duplication.
- Build verified: `go build ./...`.

## Slack Utilities Refactor (2025-08-10)
- Moved Slack-specific logic from `agent.go` to new `slack.go`:
  - `SlackCache` struct and its `Get`/`Put` methods
  - Per-channel lock registry: `getSlackChannelLock`, `removeSlackChannelLock`
  - `ensureSlackThread(channel string)`
  - `handleSlackMessage(...)`
  - `sendSlackResponse(channel, message string)`
- Removed the above from `agent.go` to reduce file size and improve maintainability.
- Build verified: `go build ./...`.

## Refactor (2025-08-10)
- Moved path normalization helpers into `utility/path_normalize.go` as exported `NormalizePathInText` and `SanitizeContextFacts`.
- Updated `gemini.go` to call `utility.SanitizeContextFacts(...)`.
- Replaced `path_normalize.go` at repo root with a stub comment to avoid duplicate symbols.
- Build verified: `go build ./...`.

### Follow-up (2025-08-10)
- Removed the legacy `path_normalize.go` file from the repo root after verifying all references point to `utility/` and build passes.

## Gemini Refactor (2025-08-10)
- Moved Gemini logic to `utility/gemini.go` with exported `GeminiAPIHandler(...)`.
- Moved context limit helper to `utility/context_limits.go`.
- Updated `agent.go` to call `utility.GeminiAPIHandler` and pass it into Slack handler.
- Removed old root files: `gemini.go`, `context_limits.go`.
- Build verified: `go build ./...`.

## Security Hardening (2025-08-11)
- Locked down WebSocket upgrader origin checks to mitigate CSWSH:
  - Replaced permissive `CheckOrigin: func(...) bool { return true }` with `isAllowedWSOrigin` in `agent.go`.
  - `isAllowedWSOrigin` allows origins from `[default] ALLOWED_ORIGINS` (comma-separated) or falls back to same-origin (`http(s)://<host>`).
  - Added `ALLOWED_ORIGINS` to `config.sample.ini` with examples.
- Build verified: `go build ./...`.

## Performance Optimization (2025-08-12)
- Cached WebSocket origin allowlist in `agent.go` to avoid per-request parsing:
  - Added package-level cache: `allowedOrigins map[string]struct{}` and `allowedOriginsOnce sync.Once`.
  - Updated `isAllowedWSOrigin()` to populate the cache on first call and use it thereafter; falls back to same-origin if no allowlist is set.
  - Benefit: reduces allocations and CPU on the WebSocket upgrade hot path.
  - Build verified: `go build ./...`.

## Observability Improvement (2025-08-12)
- File: `agent.go`
- Change: Added an explicit error log in `isAllowedWSOrigin()` when `utility.LoadConfig()` fails while reading `ALLOWED_ORIGINS`, noting fallback to same-origin policy.
- Reason: Avoid silent fallback that could confuse operators when CORS appears broken due to config load issues.
- Result: Clear log line `[ShellWS] failed to load config for allowed origins: <err>. Falling back to same-origin policy.`

## Proxy-Aware WS Origin Note (2025-08-12)
- File: `agent.go`
- Change: Added an inline comment above the same-origin fallback in `isAllowedWSOrigin()` explaining that `r.TLS` may be nil behind TLS-terminating proxies, suggesting honoring `X-Forwarded-Proto` or configuring Gin trusted proxies.
- Reason: Prevent misdiagnosis when clients connect via HTTPS through a reverse proxy but the backend computes `http://` for same-origin.
- Next: Optionally enhance scheme detection to read `X-Forwarded-Proto` when present and configure `SetTrustedProxies`.

## Shell Session PWD Extraction – Perf Improvement (2025-08-12)
- File: `tools/shell_session_tool.go`
- Change: Implemented the more memory-efficient slice-append approach in `extractCwdAndTrim()` and removed the unused `outLines` variable.
  `strings.Join(append(lines[:foundIdx], lines[foundIdx+1:]...), "\n")`
- Reason: Reduce allocations and simplify code for large outputs while keeping readability.
- Status: Implemented; build verified.

## WebSocket Single-Writer Guidance (2025-08-12)
- File: `agent.go`
- Change: Added comments at both WS write sites (writer goroutine and reader loop) warning that gorilla/websocket requires serialized writes and suggesting a shared `sync.Mutex` to guard all `conn.WriteMessage` calls.
- Reason: Prevent data corruption/panics due to concurrent writes.
- Next: Implement `writeMu` to guard all writes.

## Auth Hardening and Frontend Type Safety (2025-08-13)
- Files: `agent.go`, `web/src/components/LoginModal.tsx`, `web/src/components/SignupModal.tsx`
- Backend security:
  - `parseSession()` now decodes the cookie signature with `hex.DecodeString` and compares raw bytes via `hmac.Equal(sigBytes, expectedMAC)`. Previously compared hex strings; this is more robust and validates signature format.
  - Simplified ephemeral `SESSION_SECRET` generation by removing redundant `else` after `log.Fatalf`; code after `if` runs only on success.
  - Fixed linter warning in `getOrCreateAnyThread()` by simplifying the error check after `Scan`: `if err != sql.ErrNoRows { return 0, err }`.
  - `/login`: Mitigate username-enumeration timing attacks by performing a dummy bcrypt comparison when the user is not found. Implemented helper `dummyBcryptCompare(password)` that hashes a dummy password once at startup and calls `bcrypt.CompareHashAndPassword` to normalize timing.
- Frontend type-safety:
  - In both login and signup modals, replaced `catch (err: any)` with `catch (err: unknown)` and safe message extraction using `err instanceof Error ? err.message : String(err)`.
  - In `web/src/App.tsx`, treat `/me` response JSON as `unknown` and type-check before casting when setting `me` state.
  - In `web/src/components/LoginModal.tsx`, validate the JSON shape for successful `/login` responses before invoking `onSuccess`:
    - Ensure `data.user` exists and has `{ id: number, username: string, name: string }`.
    - For non-OK responses, safely read `(data as any).error` when available; otherwise fall back to `HTTP <status>` message.
    - Prevents passing `undefined` to `onSuccess` and improves robustness to unexpected API responses.
  - Frontend shared types:
    - Introduced `web/src/types.ts` exporting `User`, `LoginSuccess`, and guards `isUser`, `isLoginSuccess`.
    - Updated `web/src/App.tsx` and `web/src/components/LoginModal.tsx` to import and use these, removing duplicated `User` type and verbose inline checks.
  - Build status: `go build ./...` passes.

## Auth: Normalize Email Usernames (2025-08-13)
- Backend (`agent.go`):
  - Lowercase and trim usernames in both `POST /signup` and `POST /login` handlers using `strings.ToLower(strings.TrimSpace(req.Username))`.
  - Rationale: Treat email addresses case-insensitively and align with rate limiter keys (`isLocked`, `recordFailure`, `recordSuccess`), avoiding inconsistencies like `User@example.com` vs `user@example.com`.
  - Status: Implemented; `go build ./...` passes.
  - Follow-up: Consider enforcing a case-insensitive unique constraint at the DB layer (e.g., unique index on `LOWER(username)`).

## HTTPS Detection Helper Refactor (2025-08-13)
- Backend (`agent.go`):
  - Extracted `isSecure(r *http.Request)` to determine HTTPS via `r.TLS` or `X-Forwarded-Proto` using `strings.EqualFold`.
  - Updated `isSecureRequest(c *gin.Context)` to delegate to `isSecure(c.Request)`.
  - Modified `isAllowedWSOrigin(...)` to use `isSecure(r)` for scheme detection, replacing manual checks and ensuring case-insensitive handling.
  - Status: Implemented; `go build ./...` passes.

## CSRF under Vite Proxy (2025-08-13)
- Frontend (`web/vite.config.ts`): Added `'/csrf'` to `server.proxy` so `GET /csrf` is forwarded to the Go API on `127.0.0.1:7866` during dev, ensuring the `csrf_token` cookie is set for origin `http://localhost:5174`.
- Backend (`agent.go`): Enhanced `validateCSRF()` to support an origin allowlist via INI key `[default] ALLOWED_ORIGINS` and added detailed diagnostic logs for origin allow/deny, header/cookie presence, and token mismatch.
- Config: Set `ALLOWED_ORIGINS=http://localhost:5174,http://127.0.0.1:5174` in `~/.config/go-thing/config.ini` and restarted the server (Air).
- Verification: Used curl through Vite proxy to fetch a CSRF token and reuse the same cookie jar and token for `/login`. Confirmed 200 OK. The browser login flow now succeeds.
- Notes: Keep `SameSite=Strict` for `csrf_token`. Always fetch `/csrf` once immediately before the state-changing POST and send `X-CSRF-Token` with `credentials: 'include'` so cookie is attached.

## Frontend Allowed Hosts from Config (2025-08-16)
- Vite config (`web/vite.config.ts`) now derives `server.allowedHosts` from the same `ALLOWED_ORIGINS` key in `~/.config/go-thing/config.ini`, avoiding hardcoded hostnames. Implementation reads the INI file at build-time and converts origins to hostnames.
- Added the new dev host `gothing.dev.portnumber53.com` to `ALLOWED_ORIGINS` alongside localhost entries; Vite and backend now accept it. Backend logs confirmed allowlist acceptance.
- Fallback remains in Vite to the previous static host list if `ALLOWED_ORIGINS` is missing.
- Developer note: TypeScript may require Node types for `fs`, `os`, `path` in `vite.config.ts`. Install via `npm i -D @types/node` (recommended) and/or add `/// <reference types="node" />` at top of the file.

## Git History Cleanup: Remove `web/node_modules/` (2025-08-16)
- Goal: Permanently remove `web/node_modules/` from the entire Git history to reduce repo size and prevent accidental tracking.
- Ignore status: `web/.gitignore` contains `node_modules/` and `node_modules`, so new files are ignored going forward.
- Method used: `git filter-branch` (git-filter-repo unavailable).
- Safety tag created: `backup/pre-node-modules-purge-2025-08-16`.
- Commands executed (from repo root):
  - `git tag backup/pre-node-modules-purge-2025-08-16`
  - `git filter-branch --force --index-filter "git rm -r --cached --ignore-unmatch web/node_modules" --prune-empty --tag-name-filter cat -- --all`
  - `git for-each-ref --format='%(refname)' refs/original/ | xargs -r -n1 git update-ref -d`
  - `git reflog expire --expire=now --all && git gc --prune=now --aggressive`
  - `git push --force --all`
  - `git push --force --tags`
- Post-check: Verified no tracked paths remain under `web/node_modules/`.
- Collaborator instructions after force-push:
  - Re-clone OR hard reset to the rewritten history:
    - `git fetch --all`
    - `git checkout <branch>`
    - `git reset --hard origin/<branch>`
  - If you had local work, create a safety branch before resetting: `git branch backup/pre-rewrite-local`.
  - If you rely on old SHAs, use the backup tag to locate pre-rewrite commits.

## Jira Webhook Endpoint (2025-08-16)
- Backend (`agent.go`): Added `POST /webhook/jira` to accept Jira webhooks.
  - No CSRF (external origin).
  - Optional shared secret via INI `[default] JIRA_WEBHOOK_TOKEN`; when set, requests must send header `X-Webhook-Token: <token>`.
  - Reads up to 1MB body, attempts JSON parse. Logs common fields like `webhookEvent`, `issue_event_type_name`, and `issue.key`. Truncates/logs non-JSON safely.
  - Returns an empty `200 OK` on success.
- Config: Set `JIRA_WEBHOOK_TOKEN` in `~/.config/go-thing/config.ini` to enforce auth (recommended).
- Jira Setup: In Jira (Cloud/Data Center), create a Webhook pointing to `http(s)://<host>/webhook/jira`. Add a custom header `X-Webhook-Token: <your_token>` if auth is enabled.
- Next: Optionally persist events to DB and add signature verification if Jira instance supports it.

### Chat Flow Integration (2025-08-16)
- The webhook-generated prompt is now injected into the chat flow as a user message, then processed by the AI (Gemini) and stored as an assistant reply.
- HTTP response to Jira is an empty `200 OK` on success; errors during prompt generation or processing return appropriate `5xx` (or `4xx` for invalid auth/body).

## 2025-08-18 — Jira create issue tool and context SQL hardening

- Added `jira_create_issue` tool in `tools/jira_issue_ops.go`:
  - Supports full `--fields` JSON or convenience params (project, issuetype, summary, description, labels, priority, assignee, reporter, parent, update/properties/transition, etc.).
  - Auto-wraps plain-text `description`/`environment` to ADF when needed.
  - Registers executor `executeJiraCreateIssueTool` and integrates with tool registry alongside existing `jira_get_issue`, `jira_edit_issue`, and `jira_delete_issue`.
  - Improves success handling for Jira responses across 2xx statuses.
  - Robustness: Validate JSON for passthrough params (`update`, `properties`, `historyMetadata`, `transition`); if provided as strings, they must be valid JSON or we return a descriptive error to the user (avoid sending malformed strings to Jira).
  - Disambiguation: Prefer `projectId` over `projectKey`, and `issuetypeId` over `issuetypeName`, using `if/else if` to avoid setting both fields in the request.
- Hardened SQL in `utility/context.go` for reading `metadata->'current_context'`:
  - Safely handles non-array or missing `current_context` via CASE expression before checking length.

Rationale: Enables creating Jira issues directly from the agent and prevents SQL errors when `current_context` is absent or not an array.

## 2025-08-19 — Jira project management tools

- New file: `tools/jira_project_ops.go` implementing project operations aligned with existing Jira issue tools and `jiraDo()` helper.
- Registered tools (in `init()`):
  - `jira_projects_all` → GET `/rest/api/3/project` (deprecated by Jira; prefer search). Params: `expand`, `recent`, `properties`.
  - `jira_projects_recent` → GET `/rest/api/3/project/recent`. Params: `expand`, `properties`.
  - `jira_projects_search` → GET `/rest/api/3/project/search`. Params: `startAt`, `maxResults`, `orderBy`, `id`, `keys`, `query`, `typeKey`, `categoryId`, `action`, `expand`.
  - `jira_get_project` → GET `/rest/api/3/project/{projectIdOrKey}`. Params: `projectIdOrKey`, `expand`, `properties`.
  - `jira_create_project` → POST `/rest/api/3/project`. Body passthrough; helper docs list common fields (`key`, `name`, `projectTypeKey`, `projectTemplateKey`, `leadAccountId`, etc.).
  - `jira_update_project` → PUT `/rest/api/3/project/{projectIdOrKey}`. Supports common fields (`name`, `key`, `leadAccountId`, `assigneeType`, `avatarId`, `categoryId`, `description`, `issueSecurityScheme`, `notificationScheme`, `permissionScheme`, `url`).
  - `jira_delete_project` → DELETE `/rest/api/3/project/{projectIdOrKey}`. Param: `enableUndo`.
  - `jira_delete_project_async` → POST `/rest/api/3/project/{projectIdOrKey}/delete`. Returns task payload and `Location` header when present.
  - `jira_archive_project` → POST `/rest/api/3/project/{projectIdOrKey}/archive`.
  - `jira_restore_project` → POST `/rest/api/3/project/{projectIdOrKey}/restore`.
  - `jira_get_project_statuses` → GET `/rest/api/3/project/{projectIdOrKey}/statuses`.

- Behavior & consistency:
  - Uses existing config (`JIRA_URL`, `JIRA_TOKEN`, `JIRA_EMAIL`) and `jiraDo()` for auth and logging.
  - Uniform arg parsing, query construction, robust 2xx handling, and JSON unmarshalling consistent with `tools/jira_issue_ops.go`.
  - Clear errors for missing `projectIdOrKey`, 401, 404, and non-2xx statuses.

- Fixes:
  - Resolved a build error in the Help string for `jira_create_project` tool (mismatched delimiter) and verified `go build ./...` passes.

- Next steps:
  - Add end-to-end tests against a Jira Cloud sandbox for each operation.
  - Consider surfacing minimal convenience flags for `jira_create_project` (e.g., `--key`, `--name`) while retaining full body passthrough.
  - Add rate-limit/backoff handling across Jira tools if needed.

## 2025-08-19 — GitHub API layer and webhook

- Backend:
  - Added reusable GitHub client `utility/github.go` with `GitHubDo(method, path, q, body)` supporting `GITHUB_API_BASE` and `GITHUB_TOKEN` from INI `[default]`.
  - New endpoints in `agent.go`:
    - `POST /github/call` (CSRF-protected) to proxy direct GitHub REST calls with query/body normalization and 1MB body limit.
    - `POST /webhook/github` with HMAC SHA-256 validation (`X-Hub-Signature-256`) against `GITHUB_WEBHOOK_SECRET` from INI or env; logs event/repo succinctly.
  - Implemented `hmacSha256` and `hmacEqual` helpers in `agent.go` for secure signature computation and constant-time equals (case-insensitive hex).
- Tests:
  - Added `agent_github_test.go` covering signature format/length and case-insensitive equality.
- Lint:
  - Fixed redundant nil check in `utility/github.go` for `len(q)` (ID: 9ae55391-78a0-444a-8455-bb7026e35ba3).
- Config:
  - Webhook secret prefers INI `GITHUB_WEBHOOK_SECRET`, falling back to environment variable.

Next steps:
- Add unit/integration tests for `POST /github/call` and `utility/GitHubDo` (mock server + headers/assertions).
- Build initial GitHub tools (analogous to Jira): repos list/get, issues list/create/update, PR list/create/merge, comments.
- Extend webhook handling to process common events (issues, PRs, pushes) and optionally persist to DB.
- Document GitHub configuration and examples.

## 2025-08-25: GTHING-35 SSH Key Creation Feature
Committed changes to add a form for creating and exporting SSH keys in Docker container. Modified files: agent.go, web/src/App.tsx, web/vite.config.ts, and this plan. Commit hash: dfc356f. This enhances the interactive shell capabilities.
