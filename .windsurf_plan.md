# AI Agent Improvement Plan

## Objectives
- Add a chat interface for the AI agent to handle user inputs via chat and call tools.
- Implement a write_file tool restricted to a specific folder, with configuration in `~/.config/go-thing/config`.

## Steps
1. [x] Set up configuration file for restricted directory.
2. [x] Modify `toolserver.go` to implement secure write_file tool.
3. [x] Enhance `agent.go` for chat interface and tool integration.

## Updates
- Created config file at `~/.config/go-thing/config` with `write_dir` set to `/home/grimlock/work/go-thing/files`.
- Modified `toolserver.go` to implement a secure write_file tool that reads the config and restricts writes to the specified directory.
- Added terminal check to prevent hangs in non-interactive environments.
- Added debug logging for exit condition.
- Confirmed resolution of hanging issue with 'air' after adding terminal check and debug logging.

## Next Steps
1. Enhance `agent.go` chat interface for better tool integration.
2. Test the write_file functionality.

## Debugging Agent Hanging Issue
The agent hangs when started with 'air' but works with 'go run'. Added detailed logs and flushed output to diagnose. Addressing lint errors (unreachable code, defers). Cause may be Air's signal handling or buffering.

## Task List
- [x] Research Air installation and configuration for Go projects
- [x] Add Air as a development dependency (via binary or config)
- [x] Create or update .air.toml configuration file as needed
- [x] Update documentation with instructions for using Air
- [x] Test hot reloading to confirm it works as expected
- [x] Debug agent hanging issue in agent.go (resolved)
- [x] Fix 'exit' command not stopping the agent (attempt)
- [x] Add logging for input handling and retest
- [x] Add detailed debugging for chat message handling
- [x] Fix Air-specific hanging and lint errors
- [x] Retest with Air

## Changes on 2025-07-27
- Added logging to geminiAPIHandler, chat handler, and main function to improve debugging of tool chaining and API interactions.
- Enhanced system prompt to strictly require JSON for tool calls or Markdown for final responses, ensuring better iterative tool execution.
- Changed configuration file format from JSON to INI format. Updated both agent.go and toolserver.go to use INI parsing with gopkg.in/ini.v1 package. Changed write_dir key to CHROOT_DIR in [default] section.

## Debugging Response Display Issue
- Investigated and added logging to chat handler to fix frontend display issues with Gemini responses.

## Current Goal
Add Jira tools for transitioning issues: list available transitions and perform a transition, wired into the agent tool system. Then test multi-step flows (get transitions -> transition issue).

## Changes on 2025-08-08
- Refactored tools to be modular with dynamic discovery/dispatch:
  - Introduced a registry-based dispatcher in `tools/toolserver.go` using `toolExecutors` and `tools` maps.
  - Moved `disk_space` implementation to `tools/disk_space.go` and registered via `init()`.
  - Moved `write_file` implementation to `tools/write_file.go` and registered via `init()`.
  - Simplified `toolserver.go` to keep shared types, HTTP handlers, and empty registries.

- Updated `agent.go` to discover and execute tools dynamically via the tool server, now embedded in-process:
  - `getAvailableTools()` now calls `GET http://127.0.0.1:8080/api/tools` and renders the dynamic list.
  - `executeTool()` now posts tool calls to `POST /api/tools` and returns the server response.
  - The Gemini system prompt's "Available Tools" section is built at runtime from the live registry (so new tools like `jira_search_issues` are immediately usable without agent changes).
  - Implemented `/tool` command parsing to delegate execution to the tool server and `/tools` to list the live set.

### Jira Transitions Tools (2025-08-08)
- Added `jira_get_transitions` tool to fetch available transitions for an issue, supporting query params: `expand`, `transitionId`, `skipRemoteOnlyCondition`, `includeUnavailableTransitions`, `sortByOpsBarAndStatus`.
- Added `jira_transition_issue` tool to perform a transition, supporting body keys: `transition`, `fields`, `update`, `properties`, `historyMetadata` and convenience `transitionId`.
  - Registered both tools in `tools/jira_issue_ops.go` with help text and parameters.

### Developer Experience Improvements
- The tool server has been converted into a reusable package (`tools`) and is now started inside `agent.go` (as a goroutine) on `:8080`. Running `air` in the project root starts BOTH the agent and the tool server automatically.
- No need to run a separate tool server process.

## Next Steps (Follow-up)
1. Encourage the agent to call `jira_get_transitions` before `jira_transition_issue` when transition id is unknown (prompt hint or chain-of-thought hinting via tool loop).
2. Add basic unit tests for the two executors.
3. Validate `GET /api/tools` lists the new tools and `POST /api/tools` dispatch works end-to-end.
4. Add an integration test for `agent.go` multi-step flow (list transitions then transition).
5. Document required config for all Jira tools (`JIRA_URL`, `JIRA_TOKEN`, optional `JIRA_EMAIL`).
