# AI Agent Improvement Plan

## Objectives
- Add a chat interface for the AI agent to handle user inputs via chat and call tools.
- Implement a write_file tool restricted to a specific folder, with configuration in `~/.config/go-thing/config`.

## Steps
1. [x] Set up configuration file for restricted directory.
2. [x] Modify `toolserver.go` to implement secure write_file tool.
3. [x] Enhance `agent.go` for chat interface and tool integration.

## Updates
- Created config file at `~/.config/go-thing/config` with `write_dir` set to `/home/grimlock/work/go-thing/files`.
- Modified `toolserver.go` to implement a secure write_file tool that reads the config and restricts writes to the specified directory.
- Added terminal check to prevent hangs in non-interactive environments.
- Added debug logging for exit condition.
- Confirmed resolution of hanging issue with 'air' after adding terminal check and debug logging.

## Next Steps
1. Enhance `agent.go` chat interface for better tool integration.
2. Test the write_file functionality.

## PostgreSQL Integration (2025-08-09)
### Goal
- Add internal PostgreSQL support (not exposed as a tool) and run SQL migrations at startup.

### Plan
- Create `db/` package:
  - `postgres.go`: parse `[postgres]` in INI, build DSN, open `database/sql` using `pgx` stdlib driver, ping.
  - `migrate.go`: simple file-based migrations (`schema_migrations` table, lexicographic `.sql` files`).
- Wire into `main()` in `agent.go`: on startup, load INI, init DB, run migrations from `MIGRATIONS_DIR` (default `./migrations`). Continue running even if DB is not configured or connection fails.
- Provide `config.sample.ini` and an example migration under `migrations/`.

### Done
- Implemented `db/postgres.go` and `db/migrate.go`.
- Added `github.com/jackc/pgx/v5` to `go.mod` and `go mod tidy` passes; `go build` succeeds.
- Integrated DB init + `RunMigrations` in `agent.go` startup with logs.
- Added `migrations/0001_init.sql` example file.
- Added `config.sample.ini` with `[postgres]` example.
- Updated README with configuration and migration notes.
 - Added migration CLI in `agent.go`: `migrate up [--step N]`, `migrate down --step N`, `migrate status`.
 - Enhanced migration engine to support `.up.sql`/`.down.sql` conventions, stepwise up/down, and status reporting.
 - Added example down migration `migrations/0001_init.down.sql`.

### Conversation storage migrations (2025-08-09)
- Added `migrations/0002_conversations_threads_messages.up.sql` to create tables:
  - `threads` (id, title, created_at, updated_at)
  - `messages` (id, thread_id FK, role, content, metadata JSONB, created_at)
- Added `migrations/0002_conversations_threads_messages.down.sql` to drop `messages` then `threads`.
- Indexed `messages(thread_id)` and `messages(created_at)` for common queries.

## Debugging Agent Hanging Issue
The agent hangs when started with 'air' but works with 'go run'. Added detailed logs and flushed output to diagnose. Addressing lint errors (unreachable code, defers). Cause may be Air's signal handling or buffering.

## Task List
- [x] Research Air installation and configuration for Go projects
- [x] Add Air as a development dependency (via binary or config)
- [x] Create or update .air.toml configuration file as needed
- [x] Update documentation with instructions for using Air
- [x] Test hot reloading to confirm it works as expected
- [x] Debug agent hanging issue in agent.go (resolved)
- [x] Fix 'exit' command not stopping the agent (attempt)
- [x] Add logging for input handling and retest
- [x] Add detailed debugging for chat message handling
- [x] Fix Air-specific hanging and lint errors
- [x] Retest with Air

## Changes on 2025-07-27
- Added logging to geminiAPIHandler, chat handler, and main function to improve debugging of tool chaining and API interactions.
- Enhanced system prompt to strictly require JSON for tool calls or Markdown for final responses, ensuring better iterative tool execution.
- Changed configuration file format from JSON to INI format. Updated both agent.go and toolserver.go to use INI parsing with gopkg.in/ini.v1 package. Changed write_dir key to CHROOT_DIR in [default] section.

## Debugging Response Display Issue
- Investigated and added logging to chat handler to fix frontend display issues with Gemini responses.

## Current Goal
Add Jira tools for transitioning issues: list available transitions and perform a transition, wired into the agent tool system. Then test multi-step flows (get transitions -> transition issue).

## Changes on 2025-08-08
- Refactored tools to be modular with dynamic discovery/dispatch:
  - Introduced a registry-based dispatcher in `tools/toolserver.go` using `toolExecutors` and `tools` maps.
  - Moved `disk_space` implementation to `tools/disk_space.go` and registered via `init()`.
  - Moved `write_file` implementation to `tools/write_file.go` and registered via `init()`.
  - Simplified `toolserver.go` to keep shared types, HTTP handlers, and empty registries.

- Updated `agent.go` to discover and execute tools dynamically via the tool server, now embedded in-process:
  - `getAvailableTools()` now calls `GET http://127.0.0.1:8080/api/tools` and renders the dynamic list.
  - `executeTool()` now posts tool calls to `POST /api/tools` and returns the server response.
  - The Gemini system prompt's "Available Tools" section is built at runtime from the live registry (so new tools like `jira_search_issues` are immediately usable without agent changes).
  - Implemented `/tool` command parsing to delegate execution to the tool server and `/tools` to list the live set.

### Jira Transitions Tools (2025-08-08)
- Added `jira_get_transitions` tool to fetch available transitions for an issue, supporting query params: `expand`, `transitionId`, `skipRemoteOnlyCondition`, `includeUnavailableTransitions`, `sortByOpsBarAndStatus`.
- Added `jira_transition_issue` tool to perform a transition, supporting body keys: `transition`, `fields`, `update`, `properties`, `historyMetadata` and convenience `transitionId`.
  - Registered both tools in `tools/jira_issue_ops.go` with help text and parameters.

### Developer Experience Improvements
- The tool server has been converted into a reusable package (`tools`) and is now started inside `agent.go` (as a goroutine) on `:8080`. Running `air` in the project root starts BOTH the agent and the tool server automatically.
- No need to run a separate tool server process.

## Next Steps (Follow-up)
1. Encourage the agent to call `jira_get_transitions` before `jira_transition_issue` when transition id is unknown (prompt hint or chain-of-thought hinting via tool loop).
2. Add basic unit tests for the two executors.
3. Validate `GET /api/tools` lists the new tools and `POST /api/tools` dispatch works end-to-end.
4. Add an integration test for `agent.go` multi-step flow (list transitions then transition).
5. Document required config for all Jira tools (`JIRA_URL`, `JIRA_TOKEN`, optional `JIRA_EMAIL`).

## Frontend (React + Vite) and Cloudflare Workers Deployment (2025-08-08)
- Added a new React + Vite frontend under `web/` with minimal scaffolding (`index.html`, `src/main.tsx`, `src/App.tsx`, `tsconfig.json`, `vite.config.ts`).
- Added `wrangler.toml` at the repo root configured to deploy the built SPA via Workers Static Assets with SPA routing fallback:
  - `[assets] directory = "./web/dist"`
  - `not_found_handling = "single-page-application"`
  - `name = "go-thing-frontend"`, `compatibility_date = "2025-08-01"`.
- Updated `web/package.json` to include `@vitejs/plugin-react` for the Vite React plugin.

### Developer commands
- Install deps: `npm install` (in `web/`).
- Local dev: `npm run dev` (in `web/`).
- Build: `npm run build` (in `web/`).
- Preview build locally: `npm run preview` (in `web/`).
- Deploy to Workers (from repo root where `wrangler.toml` lives): `npx wrangler deploy`.

### Notes
- The Workers deployment uses Static Assets with SPA routing (`single-page-application`) so unknown navigation paths fall back to `index.html`.
- Backend/API integration can be added later via a Worker `main` script or by exposing your existing Go server behind an `/api` origin and proxying from the Worker.
- Vite dev server configured to allow the stage host by setting `server.allowedHosts = ['gothing.stage.portnumber53.com']` in `web/vite.config.ts` to fix blocked host errors when accessing via the staging domain.
- Vite dev server port changed from 5173 to 5174 via `server.port = 5174` in `web/vite.config.ts`.
 - Vite proxy targets updated from `127.0.0.1:7866` to `127.0.0.1:7866` for `/chat` and `/webhook` in `web/vite.config.ts`.

### Cleanup (2025-08-08)
- Removed the embedded HTML/JS chat UI from `agent.go` (`GET /`). The endpoint now returns a JSON health/info payload.
- The React/Vite SPA under `web/` is the only UI moving forward. During local dev, Vite proxies `/chat` and `/webhook` to `127.0.0.1:7866`.
- For production, build the SPA (`web/dist`) and deploy via Cloudflare Workers (configured in `wrangler.toml`).

## Jira User Tools (2025-08-09)
- Implemented multiple Jira user-management tools in `tools/jira_users.go`, registered via `init()` so the agent discovers them dynamically:
  - `jira_users_all` (GET /rest/api/3/users/search)
  - `jira_users_assignable_multi` (GET /rest/api/3/user/assignable/multiProjectSearch)
  - `jira_users_assignable` (GET /rest/api/3/user/assignable/search)
  - `jira_users_permission_search` (GET /rest/api/3/user/permission/search)
  - `jira_user_picker` (GET /rest/api/3/user/picker)
  - `jira_users_search` (GET /rest/api/3/user/search)
  - `jira_users_search_query` (GET /rest/api/3/user/search/query)
  - `jira_users_search_query_key` (GET /rest/api/3/user/search/query/key)
  - `jira_users_viewissue_search` (GET /rest/api/3/user/viewissue/search)

### Notes
- All tools read `JIRA_URL`, `JIRA_TOKEN`, and optional `JIRA_EMAIL` from the INI config (`[default]` section).
- Responses prefer simplified user fields when possible and fall back to raw JSON for resiliency.
- HTTP logs mask Authorization headers and truncate large bodies.

### Next Steps
1. Add unit tests for each executor with mocked HTTP.
2. Provide usage examples in the system prompt so Gemini can pick the correct user tool.
3. End-to-end test via `/tool` posts and through the chat tool loop.
4. Optionally add POST variants where Jira supports it (if needed for large queries).

## shell_exec Tool (2025-08-09)
- Added `tools/shell_exec.go` implementing a secure shell execution tool constrained to `CHROOT_DIR`.
- Behavior:
  - Executes `/bin/sh -lc "<command>"` with working directory defaulting to `CHROOT_DIR` or a validated subdirectory `--workdir`.
  - Enforces chroot boundary using `filepath.Abs`, `Clean`, and `Rel` checks (same pattern as `read_file`/`write_file`).
  - Supports `--timeout_sec` (default 60s, clamped to [1, 600]).
  - Returns `{ stdout, stderr, exit_code, workdir, command }` and treats non-zero exit as successful call with exit_code for caller inspection.

### Prompt/Agent
- No prompt changes required. The agent discovers the tool dynamically and lists it in the “Available Tools” section for Gemini.

### Next Steps
1. Add tests covering: workdir validation, timeout behavior, non-zero exit handling, and output capture.
2. Document usage in README with examples and CHROOT guidance.
3. Optionally add environment variable allowlist for commands if needed later.

## docker_start Tool (2025-08-09)
- Added `tools/docker_start.go` to start an Arch-based Docker container with the configured `CHROOT_DIR` mounted at `/app` inside the container.
- Behavior:
  - Runs `docker run -d --name <name> -v CHROOT_DIR:/app -w /app <image> sleep infinity`.
  - Defaults: `name=go-thing-arch`, `image=archlinux:latest`. Optional `--extra_args` pass-through for advanced flags.
  - Validates `CHROOT_DIR` from `~/.config/go-thing/config.ini` `[default]` section.
- Usage examples:
  - `/tool docker_start`
  - `/tool docker_start --name my-arch --extra_args "--privileged"`

### Next Steps
1. Add a complementary `docker_exec` helper to run a command inside the container (e.g., `docker exec -it <name> bash`).
2. Add a `docker_stop`/`docker_rm` tool for lifecycle management.
3. Document prerequisites (Docker installed, user in docker group) in README.

## Docker Sandbox + Lifecycle Integration (2025-08-09)
- Sandbox: `shell_exec` now runs inside an Arch Linux Docker container via `docker exec`, mapping `CHROOT_DIR` from the host to `/app` in the container and translating working directories accordingly. This isolates filesystem-touching commands from the host.
- Lifecycle helpers:
  - `StopDockerContainer()` and `RemoveDockerContainer(force bool)` added in `tools/docker_start.go`.
  - Added internal `dockerStop(name string)` helper.
- Agent shutdown: `agent.go` now best-effort stops the container on SIGINT/SIGTERM, and removes it when `[default] DOCKER_AUTO_REMOVE=true` in `~/.config/go-thing/config.ini`.
- Config sample: Added commented `DOCKER_AUTO_REMOVE` key to `config.ini.sample`.

Next:
1. Add tests for lifecycle helpers and `shell_exec` Docker execution path.
2. Document Docker prerequisites and usage in README (including `CHROOT_DIR` mapping and optional `DOCKER_EXTRA_ARGS`).
3. Consider explicit admin tool endpoints to stop/remove the container manually if needed.

## Current Context Memory (2025-08-10)
### Goal
- Let the model maintain a concise rolling context in JSON under `current_context` (and accept legacy `current_content`), and have the agent persist and resend it on future turns.

### Changes
- Updated `agent.go`:
  - `callGeminiAPI(...)` now receives `persistedContext []string` and injects a "Persisted Context (current_context)" section into the system prompt. Path: `agent.go` function `callGeminiAPI()`.
  - System prompt updated to instruct the model to optionally include `current_context` in tool-call JSON, with guidance to pick/prune only high-signal facts (<= 8 items). Path: `agent.go` in `callGeminiAPI()` system prompt assembly.
  - Extended `ToolCall` struct to parse `current_context` and `current_content` arrays. Added helper `GetMergedContext()` and `mergeStringSets()` to dedupe and merge. Path: `agent.go`.
  - `geminiAPIHandler(...)` now maintains a rolling `currentContext []string`, merges new context from each tool-call JSON, and passes it back into `callGeminiAPI(...)` on subsequent iterations. Path: `agent.go`.

### Behavior
- Model may return tool-call JSON like:
  ```json
  {"tool":"write_file","args":{"path":"/app/repo/README.md","content":"..."},"current_context":["the working dir is /app/repo/","you're using Arch, btw, as root","you can install whatever you need","the last packages installed was npm and nodejs"]}
  ```
- Agent extracts `current_context` (and `current_content` if present), merges/dedupes, keeps up to the last 8 facts, and includes them in subsequent prompts.
- Final Markdown responses are unchanged; only tool-call JSON may include the optional `current_context` key.

### Notes
- Build verified: `go build ./...` succeeds.
- Also removed a duplicate/partial `geminiAPIHandler` definition and a stray line in `processUserMessage()` to fix syntax lints.

## Performance Optimization (2025-08-10)
- Precompiled the double-slash collapsing regex at the package level in `agent.go` as `doubleSlashRegex` and refactored `normalizePathInText()` to reuse it, avoiding recompilation on every call.
- Affected code:
  - Function: `normalizePathInText()` in `agent.go`
  - Variable: `doubleSlashRegex = regexp.MustCompile(([^:])//+)` defined at package scope
  - Benefit: Minor reduction in CPU and allocations when normalizing many strings (hot path for context and messages).

## Slack Error Handling Fix (2025-08-10)
- Fixed regression in `handleSlackMessage()` where errors from `geminiAPIHandler(...)` were logged but processing continued.
- New behavior: on error, log, send a friendly Slack message ("Sorry, I encountered an error. Please try again."), respond to HTTP with `{status: "error_processed"}`, and `return` early to avoid persisting/sending invalid replies.
- Affected code: `agent.go` function `handleSlackMessage()`.

## Error Propagation Fix (2025-08-10)
- In `geminiAPIHandler(...)`, errors returned by `callGeminiAPI(...)` were logged but suppressed by returning `nil` as the error value.
- Update: now returns the original `err` to the caller and an empty message string: `return "", currentContext, err`.
- Impact: callers (e.g., HTTP handlers, Slack handler) can correctly detect failures and handle them instead of proceeding as if successful.

## Request Context Propagation (2025-08-10)
- Updated `agent.go` `handleSlackMessage()` to pass `c.Request.Context()` into `geminiAPIHandler(...)` instead of `context.Background()`.
- Benefit: respects client disconnect/cancellation and avoids orphaned work; aligns with best practices for request-scoped cancellation in Gin.

## Config Read Optimization (2025-08-10)
- Cached `CURRENT_CONTEXT_MAX_ITEMS` using `sync.Once` and a package-level variable in `agent.go`'s `getContextMaxItems()`.
- Rationale: avoid repeated config file access and string parsing inside the `geminiAPIHandler` loop (hot path).
- Note: value is fixed for process lifetime (consistent with config load via `sync.Once`).

## Minor Refactor (2025-08-10)
- Simplified `ToolCall.GetMergedContext()` to directly return `mergeStringSets(tc.CurrentContext, tc.CurrentContent)`.
- Rationale: reduce verbosity; `mergeStringSets` already handles empty/nil slices.

## Security Improvement (2025-08-10)
- In HTTP `/chat` handler, replaced detailed error echo (`fmt.Sprintf("... %v", err)`) with a generic message to avoid leaking internal details.
- Logs still record the full error for debugging; clients receive: "Failed to process message. Please try again later."

## Path Normalization + Config Cache (2025-08-10)
- Cached `CHROOT_DIR` using `sync.Once` (`chrootDirOnce`, `chrootDirCached`) to avoid repeated lookups in the hot path `normalizePathInText()`.
- Fixed a regression by restoring `normalizePathInText(s string) string` return signature and proper returns of `s`/`s2`.
